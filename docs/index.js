var Chunk,GeneratorKeys,ModulatorSource,VersionTag,Info,Bag,PresetHeader,RangeValue,ModulatorList,GeneratorList,Instrument,SampleHeader,BoundedValue,AudioDataTypes,AudioTypesSet,AudioData,parsePhdr,parsePbag,parseInst,parseIbag,parsePmod,parseImod,parsePgen,parseIgen,parseShdr,generatorKeyToIndex,IndexGeneratorKeys,RangeGeneratorKeys,SubstitutionGeneratorKeys,SampleGeneratorKeys,presetExcludedKeys,presetExcludedIndices,fixedGenerators,RangeGeneratorKeysSet,nonValueGeneratorKeysSet,ValueGeneratorKeys,ValueGeneratorKeysSet,int16min,int16max,uint16min,uint16max,DefaultInstrumentZone,Voice,DefaultModulators,InstrumentZone,PresetZone,SoundFont,Note,drumExclusiveClassesByKit,drumExclusiveClassCount,standardSet,analogSet,orchestraSet,sfxSet,defaultControllerState,ControllerState,volumeEnvelopeKeys,volumeEnvelopeKeySet,filterEnvelopeKeys,filterEnvelopeKeySet,pitchEnvelopeKeys,pitchEnvelopeKeySet,Midy,MIDIPlayer,MidiPiano,globalCSS,midy,midiPlayer,pianos,volumes,pans,expressions,programs,scheduleIndex,__create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of __getOwnPropNames(t))!__hasOwnProp.call(e,o)&&o!==n&&__defProp(e,o,{get:()=>t[o],enumerable:!(s=__getOwnPropDesc(t,o))||s.enumerable});return e},__toESM=(e,t,n)=>(n=e!=null?__create(__getProtoOf(e)):{},__copyProps(t||!e||!e.__esModule?__defProp(n,"default",{value:e,enumerable:!0}):n,e)),require_midi_parser=__commonJS({"../../../.cache/deno/deno_esbuild/registry.npmjs.org/midi-file@1.2.4/node_modules/midi-file/lib/midi-parser.js"(e,t){function s(e){var t,r,c,l,d,s=new n(e),a=s.readChunk();if(a.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+a.id+"'";for(r=o(a.data),c=[],l=0;!s.eof()&&l<r.numTracks;l++){if(t=s.readChunk(),t.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+t.id+"'";d=i(t.data),c.push(d)}return{header:r,tracks:c}}function o(e){var o=new n(e),i=o.readUInt16(),a=o.readUInt16(),t={format:i,numTracks:a},s=o.readUInt16();return s&32768?(t.framesPerSecond=256-(s>>8),t.ticksPerFrame=s&255):t.ticksPerBeat=s,t}function i(e){for(var s,i,t=new n(e),o=[];!t.eof();)i=a(),o.push(i);return o;s=null;function a(){var n,o,i,a,r,c,l,d,e={};if(e.deltaTime=t.readVarInt(),o=t.readUInt8(),(o&240)===240)if(o===255)switch(e.meta=!0,r=t.readUInt8(),n=t.readVarInt(),r){case 0:if(e.type="sequenceNumber",n!==2)throw"Expected length for sequenceNumber event is 2, got "+n;return e.number=t.readUInt16(),e;case 1:return e.type="text",e.text=t.readString(n),e;case 2:return e.type="copyrightNotice",e.text=t.readString(n),e;case 3:return e.type="trackName",e.text=t.readString(n),e;case 4:return e.type="instrumentName",e.text=t.readString(n),e;case 5:return e.type="lyrics",e.text=t.readString(n),e;case 6:return e.type="marker",e.text=t.readString(n),e;case 7:return e.type="cuePoint",e.text=t.readString(n),e;case 32:if(e.type="channelPrefix",n!=1)throw"Expected length for channelPrefix event is 1, got "+n;return e.channel=t.readUInt8(),e;case 33:if(e.type="portPrefix",n!=1)throw"Expected length for portPrefix event is 1, got "+n;return e.port=t.readUInt8(),e;case 47:if(e.type="endOfTrack",n!=0)throw"Expected length for endOfTrack event is 0, got "+n;return e;case 81:if(e.type="setTempo",n!=3)throw"Expected length for setTempo event is 3, got "+n;return e.microsecondsPerBeat=t.readUInt24(),e;case 84:if(e.type="smpteOffset",n!=5)throw"Expected length for smpteOffset event is 5, got "+n;return c=t.readUInt8(),d={0:24,32:25,64:29,96:30},e.frameRate=d[c&96],e.hour=c&31,e.min=t.readUInt8(),e.sec=t.readUInt8(),e.frame=t.readUInt8(),e.subFrame=t.readUInt8(),e;case 88:if(e.type="timeSignature",n!=2&&n!=4)throw"Expected length for timeSignature event is 4 or 2, got "+n;return e.numerator=t.readUInt8(),e.denominator=1<<t.readUInt8(),n===4?(e.metronome=t.readUInt8(),e.thirtyseconds=t.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",n!=2)throw"Expected length for keySignature event is 2, got "+n;return e.key=t.readInt8(),e.scale=t.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=t.readBytes(n),e;default:return e.type="unknownMeta",e.data=t.readBytes(n),e.metatypeByte=r,e}else if(o==240)return e.type="sysEx",n=t.readVarInt(),e.data=t.readBytes(n),e;else if(o==247)return e.type="endSysEx",n=t.readVarInt(),e.data=t.readBytes(n),e;else throw"Unrecognised MIDI event type byte: "+o;else{if((o&128)===0){if(s===null)throw"Running status byte encountered before status byte";i=o,o=s,e.running=!0}else i=t.readUInt8(),s=o;switch(l=o>>4,e.channel=o&15,l){case 8:return e.type="noteOff",e.noteNumber=i,e.velocity=t.readUInt8(),e;case 9:return a=t.readUInt8(),e.type=a===0?"noteOff":"noteOn",e.noteNumber=i,e.velocity=a,a===0&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=i,e.amount=t.readUInt8(),e;case 11:return e.type="controller",e.controllerType=i,e.value=t.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=i,e;case 13:return e.type="channelAftertouch",e.amount=i,e;case 14:return e.type="pitchBend",e.value=i+(t.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+l}}}}function n(e){this.buffer=e,this.bufferLen=this.buffer.length,this.pos=0}n.prototype.eof=function(){return this.pos>=this.bufferLen},n.prototype.readUInt8=function(){var e=this.buffer[this.pos];return this.pos+=1,e},n.prototype.readInt8=function(){var e=this.readUInt8();return e&128?e-256:e},n.prototype.readUInt16=function(){var e=this.readUInt8(),t=this.readUInt8();return(e<<8)+t},n.prototype.readInt16=function(){var e=this.readUInt16();return e&32768?e-65536:e},n.prototype.readUInt24=function(){var e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(e<<16)+(t<<8)+n},n.prototype.readInt24=function(){var e=this.readUInt24();return e&8388608?e-16777216:e},n.prototype.readUInt32=function(){var e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8(),s=this.readUInt8();return(e<<24)+(t<<16)+(n<<8)+s},n.prototype.readBytes=function(e){var t=this.buffer.slice(this.pos,this.pos+e);return this.pos+=e,t},n.prototype.readString=function(e){var t=this.readBytes(e);return String.fromCharCode.apply(null,t)},n.prototype.readVarInt=function(){for(var t,e=0;!this.eof();)if(t=this.readUInt8(),t&128)e+=t&127,e<<=7;else return e+t;return e},n.prototype.readChunk=function(){var t=this.readString(4),e=this.readUInt32(),n=this.readBytes(e);return{id:t,length:e,data:n}},t.exports=s}}),require_midi_writer=__commonJS({"../../../.cache/deno/deno_esbuild/registry.npmjs.org/midi-file@1.2.4/node_modules/midi-file/lib/midi-writer.js"(e,t){function s(e,t){if(typeof e!="object")throw"Invalid MIDI data";t=t||{};var s,l=e.header||{},r=e.tracks||[],c=r.length,a=new n;o(a,l,c);for(s=0;s<c;s++)i(a,r[s],t);return a.buffer}function o(e,t,s){var o,a=t.format==null?1:t.format,i=128;t.timeDivision?i=t.timeDivision:t.ticksPerFrame&&t.framesPerSecond?i=-(t.framesPerSecond&255)<<8|t.ticksPerFrame&255:t.ticksPerBeat&&(i=t.ticksPerBeat&32767),o=new n,o.writeUInt16(a),o.writeUInt16(s),o.writeUInt16(i),e.writeChunk("MThd",o.buffer)}function i(e,t,s){var o,r=new n,c=t.length,i=null;for(o=0;o<c;o++)(s.running===!1||!s.running&&!t[o].running)&&(i=null),i=a(r,t[o],i,s.useByte9ForNoteOff);e.writeChunk("MTrk",r.buffer)}function a(e,t,n,s){var r,l,d,u,h,m,f,c=t.type,p=t.deltaTime,i=t.text||"",a=t.data||[],o=null;switch(e.writeVarInt(p),c){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(i.length),e.writeString(i);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(i.length),e.writeString(i);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(i.length),e.writeString(i);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(i.length),e.writeString(i);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(i.length),e.writeString(i);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(i.length),e.writeString(i);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(i.length),e.writeString(i);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5),l={24:0,25:32,29:64,30:96},d=t.hour&31|l[t.frameRate],e.writeUInt8(d),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator),u=Math.floor(Math.log(t.denominator)/Math.LN2)&255,e.writeUInt8(u),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(a.length),e.writeBytes(a);break;case"unknownMeta":t.metatypeByte!=null&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(a.length),e.writeBytes(a));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(a.length),e.writeBytes(a);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(a.length),e.writeBytes(a);break;case"noteOff":h=s!==!1&&t.byte9||s&&t.velocity==0?144:128,o=h|t.channel,o!==n&&e.writeUInt8(o),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":o=144|t.channel,o!==n&&e.writeUInt8(o),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":o=160|t.channel,o!==n&&e.writeUInt8(o),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":o=176|t.channel,o!==n&&e.writeUInt8(o),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":o=192|t.channel,o!==n&&e.writeUInt8(o),e.writeUInt8(t.programNumber);break;case"channelAftertouch":o=208|t.channel,o!==n&&e.writeUInt8(o),e.writeUInt8(t.amount);break;case"pitchBend":o=224|t.channel,o!==n&&e.writeUInt8(o),r=8192+t.value,m=r&127,f=r>>7&127,e.writeUInt8(m),e.writeUInt8(f);break;default:throw"Unrecognized event type: "+c}return o}function n(){this.buffer=[]}n.prototype.writeUInt8=function(e){this.buffer.push(e&255)},n.prototype.writeInt8=n.prototype.writeUInt8,n.prototype.writeUInt16=function(e){var t=e>>8&255,n=e&255;this.writeUInt8(t),this.writeUInt8(n)},n.prototype.writeInt16=n.prototype.writeUInt16,n.prototype.writeUInt24=function(e){var t=e>>16&255,n=e>>8&255,s=e&255;this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(s)},n.prototype.writeInt24=n.prototype.writeUInt24,n.prototype.writeUInt32=function(e){var t=e>>24&255,n=e>>16&255,s=e>>8&255,o=e&255;this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(s),this.writeUInt8(o)},n.prototype.writeInt32=n.prototype.writeUInt32,n.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},n.prototype.writeString=function(e){var t,s=e.length,n=[];for(t=0;t<s;t++)n.push(e.codePointAt(t));this.writeBytes(n)},n.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var s,t=e,n=[];for(n.push(t&127),t>>=7;t;)s=t&127|128,n.push(s),t>>=7;this.writeBytes(n.reverse())}},n.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)},t.exports=s}}),require_midi_file=__commonJS({"../../../.cache/deno/deno_esbuild/registry.npmjs.org/midi-file@1.2.4/node_modules/midi-file/index.js"(e){e.parseMidi=require_midi_parser(),e.writeMidi=require_midi_writer()}}),import_midi_file=__toESM(require_midi_file()),Stream=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){const n=this.offset,s=n+e,o=this.data;let t=o.subarray(n,s).indexOf(0);t<0&&(t=e);const i=new Array(t);for(let e=0;e<t;e++)i[e]=o[n+e];return this.offset=s,String.fromCharCode(...i)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function parseChunk(e,t,n){const s=new Stream(e,t),o=s.readString(4),i=s.readDWORD(n);return new Chunk(o,i,s.offset)}function parseRiff(e,t=0,n,{padding:s=!0,bigEndian:o=!1}={}){const a=[],r=n+t;let i=t;for(;i<r;){const n=parseChunk(e,i,o);i=n.offset+n.size,s&&(i-t&1)===1&&i++,a.push(n)}return a}Chunk=class{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}},GeneratorKeys=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"],ModulatorSource=class _ModulatorSource{constructor(e,t,n,s,o){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:o})}get controllerType(){return this.cc<<7|this.index}static parse(e){const t=e>>10&63,n=e&127,s=e>>7&1,o=e>>8&1,i=e>>9&1;return new _ModulatorSource(t,i,o,s,n)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}},VersionTag=class _VersionTag{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){const t=e.readInt8(),n=e.readInt8();return new _VersionTag(t,n)}},Info=class _Info{constructor(e,t,n,s,o,i,a,r,c,l,d){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:d})}static parse(e,t){function s(e){for(let n=0;n<t.length;n++)if(t[n].type===e)return t[n]}function o(t){return new Stream(e,t.offset)}function n(e){const t=s(e);return t?o(t).readString(t.size):null}function i(e){const t=s(e);return t?VersionTag.parse(o(t)):null}const c=n("ICMT"),r=n("ICOP"),a=n("ICRD"),l=n("IENG"),d=n("INAM"),u=n("IPRD"),h=n("ISFT"),m=i("ifil"),f=n("isng"),p=n("irom"),g=i("iver");return new _Info(c,r,a,l,d,u,h,m,f,p,g)}},Bag=class _Bag{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){const t=e.readWORD(),n=e.readWORD();return new _Bag(t,n)}},PresetHeader=class _PresetHeader{constructor(e,t,n,s,o,i,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){const{presetName:e,preset:t,bank:n,library:s,genre:o,morphology:i}=this;return e==="EOP"||e===""&&t+n+s+o+i===0}static parse(e){const t=e.readString(20),n=e.readWORD(),s=e.readWORD(),o=e.readWORD(),i=e.readDWORD(),a=e.readDWORD(),r=e.readDWORD();return new _PresetHeader(t,n,s,o,i,a,r)}},RangeValue=class _RangeValue{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){const t=e.readByte(),n=e.readByte();return new _RangeValue(t,n)}},ModulatorList=class _ModulatorList{constructor(e,t,n,s,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}transform(e){const t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){const t=e.readWORD(),n=e.readWORD(),s=e.readInt16(),o=e.readWORD(),i=e.readWORD(),a=ModulatorSource.parse(t),r=ModulatorSource.parse(o);return new _ModulatorList(a,n,s,r,i)}},GeneratorList=class _GeneratorList{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return GeneratorKeys[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){const n=e.readWORD(),s=GeneratorKeys[n];let t;switch(s){case"keyRange":case"velRange":t=RangeValue.parse(e);break;case"instrument":case"sampleID":t=e.readUInt16();break;default:t=e.readInt16();break}return new _GeneratorList(n,t)}},Instrument=class _Instrument{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){const t=new _Instrument;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},SampleHeader=class _SampleHeader{constructor(e,t,n,s,o,i,a,r,c,l){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:l})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){const i=e.readString(20),n=e.readDWORD(),a=e.readDWORD();let s=e.readDWORD(),o=e.readDWORD();const r=e.readDWORD(),c=e.readByte(),l=e.readInt8(),d=e.readWORD(),u=e.readWORD();return t||(s-=n,o-=n),new _SampleHeader(i,n,a,s,o,r,c,l,d,u)}},BoundedValue=class{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=n}clamp(e){return Math.max(this.min,Math.min(e,this.max))}},AudioDataTypes=["pcm16","pcm24","compressed"],AudioTypesSet=new Set(AudioDataTypes),AudioData=class{constructor(e,t,n){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!AudioTypesSet.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=n}decodePCM(e){const{type:o}=this;if(o==="pcm16"){const t=2,n=e.byteLength/t,s=new Float32Array(n),o=new Int16Array(e.buffer,e.byteOffset,e.byteLength/t);for(let e=0;e<n;e++)s[e]=o[e]/32768;return s}const t=3,n=e.byteLength/t,s=new Float32Array(n);for(let o=0;o<n;o++){const i=o*t;let a=e[i]|e[i+1]<<8|e[i+2]<<16;a&8388608&&(a|=4278190080),s[o]=a/8388608}return s}async toAudioBuffer(e,t,n){if(this.type==="compressed"){const s=this.data.slice(t,n);return await e.decodeAudioData(s.buffer)}const i=this.data.subarray(t,n),s=this.decodePCM(i),o=new AudioBuffer({numberOfChannels:1,length:s.length,sampleRate:this.sampleHeader.sampleRate});return o.getChannelData(0).set(s),o}};function parse(e,t={}){const s=parseRiff(e,0,e.length,t);if(s.length!==1)throw new Error("wrong chunk length");const o=s[0];if(o===null)throw new Error("chunk not found");function i(e,t,n={}){const s=getChunkList(e,t,"RIFF","sfbk",n);if(s.length!==3)throw new Error("invalid sfbk structure");const o=parseInfoList(s[0],t),i=o.version.major===3;return i&&s[2].type!=="LIST"&&(s[2]=parseChunk(t,s[2].offset-9,!1)),{info:o,samplingData:parseSdtaList(s[1],t),...a(s[2],t,i)}}function a(e,t,n){const s=getChunkList(e,t,"LIST","pdta");if(s.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:parsePhdr(s[0],t),presetZone:parsePbag(s[1],t),presetModulators:parsePmod(s[2],t),presetGenerators:parsePgen(s[3],t),instruments:parseInst(s[4],t),instrumentZone:parseIbag(s[5],t),instrumentModulators:parseImod(s[6],t),instrumentGenerators:parseIgen(s[7],t),sampleHeaders:parseShdr(s[8],t,n)}}const n=i(o,e,t),r=n.info.version.major===3;return{...n,samples:loadSamples(n.sampleHeaders,n.samplingData.offsetMSB,n.samplingData.offsetLSB,e,r)}}function getChunkList(e,t,n,s,o={}){if(e.type!==n)throw new Error("invalid chunk type:"+e.type);const i=new Stream(t,e.offset),a=i.readString(4);if(a!==s)throw new Error("invalid signature:"+a);return parseRiff(t,i.offset,e.size-4,o)}function parseInfoList(e,t){const n=getChunkList(e,t,"LIST","INFO");return Info.parse(t,n)}function parseSdtaList(e,t){const n=getChunkList(e,t,"LIST","sdta");return{offsetMSB:n[0].offset,offsetLSB:n[1]?.offset}}function parseChunkObjects(e,t,n,s,o,i){const a=[];if(e.type!==n)throw new Error("invalid chunk type:"+e.type);const r=new Stream(t,e.offset),c=e.offset+e.size;for(;r.offset<c;){const e=s.parse(r,i);if(o&&o(e))break;a.push(e)}return a}parsePhdr=(e,t)=>parseChunkObjects(e,t,"phdr",PresetHeader,e=>e.isEnd),parsePbag=(e,t)=>parseChunkObjects(e,t,"pbag",Bag),parseInst=(e,t)=>parseChunkObjects(e,t,"inst",Instrument,e=>e.isEnd),parseIbag=(e,t)=>parseChunkObjects(e,t,"ibag",Bag),parsePmod=(e,t)=>parseChunkObjects(e,t,"pmod",ModulatorList),parseImod=(e,t)=>parseChunkObjects(e,t,"imod",ModulatorList),parsePgen=(e,t)=>parseChunkObjects(e,t,"pgen",GeneratorList,e=>e.isEnd),parseIgen=(e,t)=>parseChunkObjects(e,t,"igen",GeneratorList),parseShdr=(e,t,n)=>parseChunkObjects(e,t,"shdr",SampleHeader,e=>e.isEnd,n);function loadSamples(e,t,n,s,o){const i=new Array(e.length),a=o?1:2,r=o?"compressed":n?"pcm24":"pcm16";for(let n=0;n<e.length;n++){const{start:o,end:c}=e[n],l=t+o*a,d=t+c*a,u=s.subarray(l,d);i[n]=new AudioData(r,e[n],u)}return i}generatorKeyToIndex=new Map;for(let e=0;e<GeneratorKeys.length;e++)generatorKeyToIndex.set(GeneratorKeys[e],e);IndexGeneratorKeys=["instrument","sampleID"],RangeGeneratorKeys=["keyRange","velRange"],SubstitutionGeneratorKeys=["keynum","velocity"],SampleGeneratorKeys=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],presetExcludedKeys=[...SampleGeneratorKeys,...SubstitutionGeneratorKeys],presetExcludedIndices=new Set;for(let e=0;e<presetExcludedKeys.length;e++){const n=presetExcludedKeys[e],t=generatorKeyToIndex.get(n);t!==void 0&&presetExcludedIndices.add(t)}function convertToInstrumentGeneratorParams(e){const t={},n=Object.keys(e);for(const s of n){const o=e[s];if(isRangeGenerator(s))t[s]=o;else{const e=o;t[s]=e.clamp(e.defaultValue)}}return t}fixedGenerators=[["keynum","keyRange"],["velocity","velRange"]],RangeGeneratorKeysSet=new Set(RangeGeneratorKeys);function isRangeGenerator(e){return RangeGeneratorKeysSet.has(e)}nonValueGeneratorKeysSet=new Set([...IndexGeneratorKeys,...RangeGeneratorKeys,...SubstitutionGeneratorKeys,...SampleGeneratorKeys]);function extractValueGeneratorKeys(){const e=[],t=GeneratorKeys.length;for(let n=0;n<t;n++){const s=GeneratorKeys[n];s!==void 0&&!nonValueGeneratorKeysSet.has(s)&&e.push(s)}return e}ValueGeneratorKeys=extractValueGeneratorKeys(),ValueGeneratorKeysSet=new Set(ValueGeneratorKeys);function isValueGenerator(e){return ValueGeneratorKeysSet.has(e)}function createPresetGeneratorObject(e){const t={};for(let o=0;o<e.length;o++){const n=e[o],s=n.type;if(s===void 0)continue;if(presetExcludedIndices.has(n.code))continue;if(isRangeGenerator(s))t[s]=n.value;else{const e=s;t[e]=n.value}}return t}function createInstrumentGeneratorObject(e){const t={};for(let s=0;s<e.length;s++){const o=e[s],n=o.type;if(n===void 0)continue;if(isRangeGenerator(n))t[n]=o.value;else{const e=n;t[e]=o.value}}for(let e=0;e<fixedGenerators.length;e++){const[s,o]=fixedGenerators[e],n=t[s];if(n===void 0)continue;t[o]=new RangeValue(n,n)}return t}int16min=-32768,int16max=32767,uint16min=0,uint16max=65535,DefaultInstrumentZone={startAddrsOffset:new BoundedValue(0,0,int16max),endAddrsOffset:new BoundedValue(int16min,0,0),startloopAddrsOffset:new BoundedValue(int16min,0,int16max),endloopAddrsOffset:new BoundedValue(int16min,0,int16max),startAddrsCoarseOffset:new BoundedValue(0,0,int16max),modLfoToPitch:new BoundedValue(-12e3,0,12e3),vibLfoToPitch:new BoundedValue(-12e3,0,12e3),modEnvToPitch:new BoundedValue(-12e3,0,12e3),initialFilterFc:new BoundedValue(1500,13500,13500),initialFilterQ:new BoundedValue(0,0,960),modLfoToFilterFc:new BoundedValue(-12e3,0,12e3),modEnvToFilterFc:new BoundedValue(-12e3,0,12e3),endAddrsCoarseOffset:new BoundedValue(int16min,0,0),modLfoToVolume:new BoundedValue(-960,0,960),chorusEffectsSend:new BoundedValue(0,0,1e3),reverbEffectsSend:new BoundedValue(0,0,1e3),pan:new BoundedValue(-500,0,500),delayModLFO:new BoundedValue(-12e3,-12e3,5e3),freqModLFO:new BoundedValue(-16e3,0,4500),delayVibLFO:new BoundedValue(-12e3,-12e3,5e3),freqVibLFO:new BoundedValue(-16e3,0,4500),delayModEnv:new BoundedValue(-12e3,-12e3,5e3),attackModEnv:new BoundedValue(-12e3,-12e3,8e3),holdModEnv:new BoundedValue(-12e3,-12e3,5e3),decayModEnv:new BoundedValue(-12e3,-12e3,8e3),sustainModEnv:new BoundedValue(0,0,1e3),releaseModEnv:new BoundedValue(-12e3,-12e3,8e3),keynumToModEnvHold:new BoundedValue(-1200,0,1200),keynumToModEnvDecay:new BoundedValue(-1200,0,1200),delayVolEnv:new BoundedValue(-12e3,-12e3,5e3),attackVolEnv:new BoundedValue(-12e3,-12e3,8e3),holdVolEnv:new BoundedValue(-12e3,-12e3,5e3),decayVolEnv:new BoundedValue(-12e3,-12e3,8e3),sustainVolEnv:new BoundedValue(0,0,1440),releaseVolEnv:new BoundedValue(-12e3,-12e3,8e3),keynumToVolEnvHold:new BoundedValue(-1200,0,1200),keynumToVolEnvDecay:new BoundedValue(-1200,0,1200),instrument:new BoundedValue(uint16min,uint16max,uint16max),keyRange:new RangeValue(0,127),velRange:new RangeValue(0,127),startloopAddrsCoarseOffset:new BoundedValue(int16min,0,int16max),keynum:new BoundedValue(-1,-1,127),velocity:new BoundedValue(-1,-1,127),initialAttenuation:new BoundedValue(0,0,1440),endloopAddrsCoarseOffset:new BoundedValue(int16min,0,int16max),coarseTune:new BoundedValue(-120,0,120),fineTune:new BoundedValue(-99,0,99),sampleID:new BoundedValue(uint16min,uint16max,uint16max),sampleModes:new BoundedValue(0,0,3),scaleTuning:new BoundedValue(0,100,100),exclusiveClass:new BoundedValue(0,0,127),overridingRootKey:new BoundedValue(-1,-1,127)};function timecentToSecond(e){return Math.pow(2,e/1200)}Voice=class{constructor(e,t,n,s,o){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(e,t)=>{e.modLfoToPitch=this.clamp("modLfoToPitch",t)},vibLfoToPitch:(e,t)=>{e.vibLfoToPitch=this.clamp("vibLfoToPitch",t)},modEnvToPitch:(e,t)=>{e.modEnvToPitch=this.clamp("modEnvToPitch",t)},initialFilterFc:(e,t)=>{e.initialFilterFc=this.clamp("initialFilterFc",t)},initialFilterQ:(e,t)=>{e.initialFilterQ=this.clamp("initialFilterQ",t)},modLfoToFilterFc:(e,t)=>{e.modLfoToFilterFc=this.clamp("modLfoToFilterFc",t)},modEnvToFilterFc:(e,t)=>{e.modEnvToFilterFc=this.clamp("modEnvToFilterFc",t)},modLfoToVolume:(e,t)=>{e.modLfoToVolume=this.clamp("modLfoToVolume",t)},chorusEffectsSend:(e,t)=>{e.chorusEffectsSend=this.clamp("chorusEffectsSend",t)/1e3},reverbEffectsSend:(e,t)=>{e.reverbEffectsSend=this.clamp("reverbEffectsSend",t)/1e3},pan:(e,t)=>{e.pan=this.clamp("pan",t)/1e3},delayModLFO:(e,t)=>{e.delayModLFO=timecentToSecond(this.clamp("delayModLFO",t))},freqModLFO:(e,t)=>{e.freqModLFO=this.clamp("freqModLFO",t)},delayVibLFO:(e,t)=>{e.delayVibLFO=timecentToSecond(this.clamp("delayVibLFO",t))},freqVibLFO:(e,t)=>{e.freqVibLFO=this.clamp("freqVibLFO",t)},delayModEnv:(e,t)=>{e.modDelay=timecentToSecond(this.clamp("delayModEnv",t))},attackModEnv:(e,t)=>{e.modAttack=timecentToSecond(this.clamp("attackModEnv",t))},holdModEnv:(e,t)=>{const n=this.clamp("holdModEnv",t),s=this.clamp("keynumToModEnvHold",t);e.modHold=this.getModHold(n,s)},decayModEnv:(e,t)=>{const n=this.clamp("decayModEnv",t),s=this.clamp("keynumToModEnvDecay",t);e.modDecay=this.getModDecay(n,s)},sustainModEnv:(e,t)=>{e.modSustain=this.clamp("sustainModEnv",t)/1e3},releaseModEnv:(e,t)=>{e.modRelease=timecentToSecond(this.clamp("releaseModEnv",t))},keynumToModEnvHold:(e,t)=>{const n=this.clamp("holdModEnv",t),s=this.clamp("keynumToModEnvHold",t);e.modHold=this.getModHold(n,s)},keynumToModEnvDecay:(e,t)=>{const n=this.clamp("decayModEnv",t),s=this.clamp("keynumToModEnvDecay",t);e.modDecay=this.getModDecay(n,s)},delayVolEnv:(e,t)=>{e.volDelay=timecentToSecond(this.clamp("delayVolEnv",t))},attackVolEnv:(e,t)=>{e.volAttack=timecentToSecond(this.clamp("attackVolEnv",t))},holdVolEnv:(e,t)=>{const n=this.clamp("holdVolEnv",t),s=this.clamp("keynumToVolEnvHold",t);e.volHold=this.getVolHold(n,s)},decayVolEnv:(e,t)=>{const n=this.clamp("decayVolEnv",t),s=this.clamp("keynumToVolEnvDecay",t);e.volDecay=this.getVolDecay(n,s)},sustainVolEnv:(e,t)=>{e.volSustain=this.clamp("sustainVolEnv",t)/1e3},releaseVolEnv:(e,t)=>{e.volRelease=timecentToSecond(this.clamp("releaseVolEnv",t))},keynumToVolEnvHold:(e,t)=>{const n=this.clamp("holdVolEnv",t),s=this.clamp("keynumToVolEnvHold",t);e.modHold=this.getVolHold(n,s)},keynumToVolEnvDecay:(e,t)=>{const n=this.clamp("decayVolEnv",t),s=this.clamp("keynumToVolEnvDecay",t);e.modDecay=this.getVolDecay(n,s)},initialAttenuation:(e,t)=>{e.initialAttenuation=this.clamp("initialAttenuation",t)},coarseTune:(e,t)=>{e.playbackRate=this.getPlaybackRate(t)},fineTune:(e,t)=>{e.playbackRate=this.getPlaybackRate(t)},scaleTuning:(e,t)=>{e.playbackRate=this.getPlaybackRate(t)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){const t=this.modulators[e],n=t.sourceOper.controllerType,o=t.destinationOper,s=this.controllerToDestinations.get(n);s?s.add(t.destinationOper):this.controllerToDestinations.set(n,new Set([o]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){const t=this.modulators[e],n=t.destinationOper,s=this.destinationToModulators.get(n);s?s.push(t):this.destinationToModulators.set(n,[t])}}getModHold(e,t){return timecentToSecond(e+(this.key-60)*t)}getModDecay(e,t){return timecentToSecond(e+(this.key-60)*t)}getVolHold(e,t){return timecentToSecond(e+(this.key-60)*t)}getVolDecay(e,t){return timecentToSecond(e+(this.key-60)*t)}getPlaybackRate(e){const n=this.clamp("coarseTune",e),s=this.clamp("fineTune",e)/100,t=this.clamp("overridingRootKey",e),o=this.clamp("scaleTuning",e)/100,i=n+s,a=t===-1?this.sampleHeader.originalPitch:t,r=i+this.sampleHeader.pitchCorrection/100-a;return Math.pow(Math.pow(2,1/12),(this.key+r)*o)}transformParams(e,t){const n={},s=this.controllerToDestinations.get(e);if(!s)return n;for(const o of s){const e=GeneratorKeys[o];if(!e)continue;if(!isValueGenerator(e))continue;const i=this.destinationToModulators.get(o);if(!i)continue;n[e]=this.generators[e];for(const o of i){const a=o.sourceOper,l=a.map(t[a.controllerType]);let r=1;const s=o.amountSourceOper;if(s.cc!==0||s.index!==0){const e=t[s.controllerType];r=s.map(e)}const c=o.transform(l*r);if(Number.isNaN(c))continue;n[e]+=c}}return n}transformAllParams(e){const t=structuredClone(this.generators);for(const n of this.modulators){const c=n.sourceOper.controllerType,i=e[c];if(!i)continue;const o=GeneratorKeys[n.destinationOper];if(!o)continue;if(!isValueGenerator(o))continue;const l=n.sourceOper,d=l.map(i);let a=1;const s=n.amountSourceOper;if(s.cc!==0||s.index!==0){const t=e[s.controllerType];a=s.map(t)}const r=n.transform(d*a);if(Number.isNaN(r))continue;t[o]+=r}return t}clamp(e,t){return DefaultInstrumentZone[e].clamp(t[e])}getParams(e,t){const n={},s=structuredClone(this.generators),o=this.transformParams(e,t),i=Object.keys(o);for(const e of i)s[e]=o[e];for(const e of i)this.voiceHandlers[e](n,s);return n}getAllParams(e){const t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},n=this.transformAllParams(e);for(let e=0;e<ValueGeneratorKeys.length;e++){const s=ValueGeneratorKeys[e];this.voiceHandlers[s](t,n)}return t}},DefaultModulators=[new ModulatorList(ModulatorSource.parse(1282),48,960,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(258),8,-2400,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(13),6,50,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(129),6,50,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(1415),48,960,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(650),48,1,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(1419),48,960,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(219),16,.2,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(221),15,.2,ModulatorSource.parse(0),0),new ModulatorList(ModulatorSource.parse(526),51,127,ModulatorSource.parse(16),0)],InstrumentZone=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},PresetZone=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},SoundFont=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,n,s){const o=new Array(s-n);for(let i=n;i<s;i++){const a=t[i].generatorIndex,r=t[i+1].generatorIndex;o[i-n]=e.slice(a,r)}return o}getPresetGenerators(e){const n=this.parsed.presetHeaders[e],t=this.parsed.presetHeaders[e+1],s=t?t.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,n.presetBagIndex,s)}getInstrumentGenerators(e){const n=this.parsed.instruments[e],t=this.parsed.instruments[e+1],s=t?t.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,n.instrumentBagIndex,s)}getModulators(e,t,n,s){const o=new Array(s-n);for(let i=n;i<s;i++){const a=t[i].modulatorIndex,r=t[i+1].modulatorIndex;o[i-n]=e.slice(a,r)}return o}getPresetModulators(e){const n=this.parsed.presetHeaders[e],t=this.parsed.presetHeaders[e+1],s=t?t.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,n.presetBagIndex,s)}getInstrumentModulators(e){const n=this.parsed.instruments[e],t=this.parsed.instruments[e+1],s=t?t.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,n.instrumentBagIndex,s)}findInstrumentZone(e,t,n){const i=this.getInstrumentGenerators(e),s=this.getInstrumentModulators(e);let o,a=[];for(let r=0;r<i.length;r++){const e=createInstrumentGeneratorObject(i[r]);if(e.sampleID===void 0){o=e,a=s[r];continue}if(e.keyRange&&!e.keyRange.in(t))continue;if(e.velRange&&!e.velRange.in(n))continue;if(o){const t={...o,...e},n=[...a,...s[r]];return new InstrumentZone(t,n)}return new InstrumentZone(e,s[r])}}findInstrument(e,t,n){const i=this.getPresetGenerators(e),s=this.getPresetModulators(e);let o,a=[];for(let r=0;r<i.length;r++){const e=createPresetGeneratorObject(i[r]);if(e.instrument===void 0){o=e,a=s[r];continue}if(e.keyRange&&!e.keyRange.in(t))continue;if(e.velRange&&!e.velRange.in(n))continue;const c=this.findInstrumentZone(e.instrument,t,n);if(c){if(o){const n={...o,...e},i=[...a,...s[r]],l=new PresetZone(n,i);return this.createVoice(t,l,c)}const n=new PresetZone(e,s[r]);return this.createVoice(t,n,c)}}return null}createVoice(e,t,n){const s=convertToInstrumentGeneratorParams(DefaultInstrumentZone);Object.assign(s,n.generators);const o=Object.keys(t.generators);for(let e=0;e<o.length;e++){const n=o[e];if(isRangeGenerator(n))continue;s[n]+=t.generators[n]}const a=[...DefaultModulators,...t.modulators,...n.modulators],i=s.sampleID,r=this.parsed.samples[i],c=this.parsed.sampleHeaders[i];return new Voice(e,s,a,r,c)}getVoice(e,t,n,s){const o=this.parsed.presetHeaders.findIndex(n=>n.preset===t&&n.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;const i=this.findInstrument(o,n,s);return i||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){const e={},t=this.parsed.presetHeaders;for(let s=0;s<t.length;s++){const n=t[s];e[n.bank]||(e[n.bank]={}),e[n.bank][n.preset]=n.presetName}return e}},Note=class{voice;voiceParams;index=-1;ending=!1;pending=!0;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbSend;chorusSend;portamentoNoteNumber=-1;pressure=0;constructor(e,t,n){this.noteNumber=e,this.velocity=t,this.startTime=n}},drumExclusiveClassesByKit=new Array(57),drumExclusiveClassCount=10,standardSet=new Uint8Array(128),standardSet[42]=1,standardSet[44]=1,standardSet[46]=1,standardSet[71]=2,standardSet[72]=2,standardSet[73]=3,standardSet[74]=3,standardSet[78]=4,standardSet[79]=4,standardSet[80]=5,standardSet[81]=5,standardSet[29]=6,standardSet[30]=6,standardSet[86]=7,standardSet[87]=7,drumExclusiveClassesByKit[0]=standardSet,analogSet=new Uint8Array(128),analogSet[42]=8,analogSet[44]=8,analogSet[46]=8,drumExclusiveClassesByKit[25]=analogSet,orchestraSet=new Uint8Array(128),orchestraSet[27]=9,orchestraSet[28]=9,orchestraSet[29]=9,drumExclusiveClassesByKit[48]=orchestraSet,sfxSet=new Uint8Array(128),sfxSet[41]=10,sfxSet[42]=10,drumExclusiveClassesByKit[56]=sfxSet,defaultControllerState={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},polyphonicKeyPressure:{type:10,defaultValue:0},channelPressure:{type:13,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:128+1,defaultValue:0},portamentoTime:{type:128+5,defaultValue:0},volume:{type:128+7,defaultValue:100/127},pan:{type:128+10,defaultValue:64/127},expression:{type:128+11,defaultValue:1},sustainPedal:{type:128+64,defaultValue:0},portamento:{type:128+65,defaultValue:0},sostenutoPedal:{type:128+66,defaultValue:0},softPedal:{type:128+67,defaultValue:0},filterResonance:{type:128+71,defaultValue:64/127},releaseTime:{type:128+72,defaultValue:64/127},attackTime:{type:128+73,defaultValue:64/127},brightness:{type:128+74,defaultValue:64/127},decayTime:{type:128+75,defaultValue:64/127},vibratoRate:{type:128+76,defaultValue:64/127},vibratoDepth:{type:128+77,defaultValue:64/127},vibratoDelay:{type:128+78,defaultValue:64/127},reverbSendLevel:{type:128+91,defaultValue:0},chorusSendLevel:{type:128+93,defaultValue:0}},ControllerState=class{array=new Float32Array(256);constructor(){const e=Object.entries(defaultControllerState);for(const[n,{type:t,defaultValue:s}]of e)this.array[t]=s,Object.defineProperty(this,n,{get:()=>this.array[t],set:e=>this.array[t]=e,enumerable:!0,configurable:!0})}},volumeEnvelopeKeys=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],volumeEnvelopeKeySet=new Set(volumeEnvelopeKeys),filterEnvelopeKeys=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],filterEnvelopeKeySet=new Set(filterEnvelopeKeys),pitchEnvelopeKeys=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],pitchEnvelopeKeySet=new Set(pitchEnvelopeKeys),Midy=class{mode="GM2";masterFineTuning=0;masterCoarseTuning=0;reverb={algorithm:"SchroederReverb",time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};numChannels=16;ticksPerBeat=120;totalTime=0;lastActiveSensing=0;activeSensingThreshold=.3;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=Array.from({length:128},()=>[]);voiceCounter=new Map;voiceCache=new Map;realtimeVoiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;playPromise;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*drumExclusiveClassCount);static channelSettings={scheduleIndex:0,detune:0,programNumber:0,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,mono:!1,modulationDepthRange:50,fineTuning:0,coarseTuning:0};constructor(e){this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.messageHandlers=this.createMessageHandlers(),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.keyBasedControllerHandlers=this.createKeyBasedControllerHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.createReverbEffect(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterVolume),this.reverbEffect.output.connect(this.masterVolume),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM2SystemOn()}addSoundFont(e){const n=this.soundFonts.length;this.soundFonts.push(e);const t=e.parsed.presetHeaders,s=this.soundFontTable;for(let e=0;e<t.length;e++){const{preset:o,bank:i}=t[e];s[o][i]=n}}async toUint8Array(e){let t;if(typeof e=="string"){const n=await fetch(e),s=await n.arrayBuffer();t=new Uint8Array(s)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){const t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=this.toUint8Array(e[n]);const n=await Promise.all(t);for(let e=0;e<n.length;e++){const t=parse(n[e]),s=new SoundFont(t);this.addSoundFont(s)}}else{const t=await this.toUint8Array(e),n=parse(t),s=new SoundFont(n);this.addSoundFont(s)}}async loadMIDI(e){this.voiceCounter.clear();const s=await this.toUint8Array(e),t=(0,import_midi_file.parseMidi)(s);this.ticksPerBeat=t.header.ticksPerBeat;const n=this.extractMidiData(t);this.instruments=n.instruments,this.timeline=n.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){const e=this.timeline;for(let n=0;n<e.length;n++){const t=e[n];switch(t.type){case"noteOn":{const e=this.getVoiceId(this.channels[t.channel],t.noteNumber,t.velocity);this.voiceCounter.set(e,(this.voiceCounter.get(e)??0)+1);break}case"controller":t.controllerType===0?this.setBankMSB(t.channel,t.value):t.controllerType===32&&this.setBankLSB(t.channel,t.value);break;case"programChange":this.setProgramChange(t.channel,t.programNumber,t.startTime)}}for(const[e,t]of this.voiceCounter)t===1&&this.voiceCounter.delete(e);this.GM2SystemOn()}getVoiceId(e,t,n){const i=e.programNumber,s=this.soundFontTable[i];if(!s)return;const a=e.isDrum?128:e.bankLSB,r=s[a]!==void 0?a:0,o=s[r];if(o===void 0)return;const c=this.soundFonts[o],l=c.getVoice(r,i,t,n),{instrument:d,sampleID:u}=l.generators;return o*2**32+(d<<16)+u}createChannelAudioNodes(e){const{gainLeft:o,gainRight:i}=this.panToGain(defaultControllerState.pan.defaultValue),n=new GainNode(e,{gain:o}),s=new GainNode(e,{gain:i}),t=new ChannelMergerNode(e,{numberOfInputs:2});return n.connect(t,0,0),s.connect(t,0,1),t.connect(this.masterVolume),{gainL:n,gainR:s,merger:t}}resetChannelTable(e){e.controlTable.fill(-1),e.scaleOctaveTuningTable.fill(0),e.channelPressureTable.fill(-1),e.polyphonicKeyPressureTable.fill(-1),e.keyBasedTable.fill(-1)}createChannels(e){const t=Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new ControllerState,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[],sostenutoNotes:[],controlTable:this.initControlTable(),scaleOctaveTuningTable:new Float32Array(12),channelPressureTable:new Int8Array(6).fill(-1),polyphonicKeyPressureTable:new Int8Array(6).fill(-1),keyBasedTable:new Int8Array(128*128).fill(-1),keyBasedGainLs:new Array(128),keyBasedGainRs:new Array(128)}));return t}async createAudioBuffer(e){const t=e.sample,n=e.start,s=t.data.length+e.end,o=await t.toAudioBuffer(this.audioContext,n,s);return o}isLoopDrum(e,t){const n=e.programNumber;return n===48&&t===88||n===56&&47<=t&&t<=84}createBufferSource(e,t,n,s){const o=new AudioBufferSourceNode(this.audioContext);return o.buffer=s,o.loop=e.isDrum?this.isLoopDrum(e,t):n.sampleModes%2!==0,o.loop&&(o.loopStart=n.loopStart/n.sampleRate,o.loopEnd=n.loopEnd/n.sampleRate),o}async scheduleTimelineEvents(e,t){const n=this.resumeTime-this.startTime,o=e+n+this.lookAhead,i=this.startDelay-n,s=this.timeline;for(;t<s.length;){const e=s[t];if(o<e.startTime)break;const n=e.startTime+i;switch(e.type){case"noteOn":await this.noteOn(e.channel,e.noteNumber,e.velocity,n);break;case"noteOff":{const t=this.noteOff(e.channel,e.noteNumber,e.velocity,n,!1);t&&this.notePromises.push(t);break}case"noteAftertouch":this.setPolyphonicKeyPressure(e.channel,e.noteNumber,e.amount,n);break;case"controller":this.setControlChange(e.channel,e.controllerType,e.value,n);break;case"programChange":this.setProgramChange(e.channel,e.programNumber,n);break;case"channelAftertouch":this.setChannelPressure(e.channel,e.amount,n);break;case"pitchBend":this.setPitchBend(e.channel,e.value+8192,n);break;case"sysEx":this.handleSysEx(e.data,n)}t++}return t}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}resetAllStates(){this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear(),this.realtimeVoiceCache.clear();for(let e=0;e<this.channels.length;e++)this.channels[e].scheduledNotes=[],this.resetChannelStates(e)}updateStates(e,t){t<e&&(e=0);for(let s=e;s<t;s++){const n=this.timeline[s];switch(n.type){case"controller":this.setControlChange(n.channel,n.controllerType,n.value,0);break;case"programChange":this.setProgramChange(n.channel,n.programNumber,0);break;case"pitchBend":this.setPitchBend(n.channel,n.value+8192,0);break;case"sysEx":this.handleSysEx(n.data,0)}}}async playNotes(){this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let e=this.getQueueIndex(this.resumeTime),t=!1;for(this.notePromises=[];e<this.timeline.length;){const n=this.audioContext.currentTime;if(0<this.lastActiveSensing&&this.activeSensingThreshold<performance.now()-this.lastActiveSensing){await this.stopNotes(0,!0,n),await this.audioContext.suspend(),t=!0;break}if(this.isPausing){await this.stopNotes(0,!0,n),await this.audioContext.suspend(),this.notePromises=[];break}if(this.isStopping){await this.stopNotes(0,!0,n),await this.audioContext.suspend(),t=!0;break}if(this.isSeeking){await this.stopNotes(0,!0,n),this.startTime=this.audioContext.currentTime;const t=this.getQueueIndex(this.resumeTime);this.updateStates(e,t),e=t,this.isSeeking=!1;continue}e=await this.scheduleTimelineEvents(n,e);const s=n+this.noteCheckInterval;await this.scheduleTask(()=>{},s)}t&&(this.notePromises=[],this.resetAllStates(),this.lastActiveSensing=0),this.isPlaying=!1}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getSoundFontId(e){const t=e.programNumber,n=e.isDrum?128:e.bankLSB,s=n.toString().padStart(3,"0"),o=t.toString().padStart(3,"0");return`${s}:${o}`}extractMidiData(e){const n=new Set,t=[],i=this.channels;for(let s=0;s<e.tracks.length;s++){const o=e.tracks[s];let a=0;for(let s=0;s<o.length;s++){const e=o[s];switch(a+=e.deltaTime,e.ticks=a,e.type){case"noteOn":{const t=i[e.channel];n.add(this.getSoundFontId(t));break}case"controller":switch(e.controllerType){case 0:this.setBankMSB(e.channel,e.value);break;case 32:this.setBankLSB(e.channel,e.value);break}break;case"programChange":{const t=i[e.channel];this.setProgramChange(e.channel,e.programNumber),n.add(this.getSoundFontId(t));break}case"sysEx":{const t=e.data;if(t[0]===126&&t[1]===9&&t[2]===3)switch(t[3]){case 1:this.GM1SystemOn(scheduleTime);break;case 2:break;case 3:this.GM2SystemOn(scheduleTime);break;default:console.warn(`Unsupported Exclusive Message: ${t}`)}}}delete e.deltaTime,t.push(e)}}const a={controller:0,sysEx:1,noteOff:2,noteOn:3};t.sort((e,t)=>e.ticks!==t.ticks?e.ticks-t.ticks:(a[e.type]||4)-(a[t.type]||4));let r=0,s=0,o=.5;for(let n=0;n<t.length;n++){const e=t[n],i=this.ticksToSecond(e.ticks-s,o);e.startTime=r+i,e.type==="setTempo"&&(r+=this.ticksToSecond(e.ticks-s,o),o=e.microsecondsPerBeat/1e6,s=e.ticks)}return{instruments:n,timeline:t}}stopActiveNotes(e,t,n,s){const i=this.channels[e],o=[];return this.processActiveNotes(i,s,i=>{const a=this.noteOff(e,i.noteNumber,t,s,n);this.notePromises.push(a),o.push(a)}),Promise.all(o)}stopChannelNotes(e,t,n,s){const i=this.channels[e],o=[];return this.processScheduledNotes(i,i=>{const a=this.noteOff(e,i.noteNumber,t,s,n);this.notePromises.push(a),o.push(a)}),Promise.all(o)}stopNotes(e,t,n){const s=[];for(let o=0;o<this.channels.length;o++)s.push(this.stopChannelNotes(o,e,t,n));return Promise.all(this.notePromises)}async start(){if(this.isPlaying||this.isPaused)return;this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),this.playPromise=this.playNotes(),await this.playPromise}async stop(){if(!this.isPlaying)return;this.isStopping=!0,await this.playPromise,this.isStopping=!1}async pause(){if(!this.isPlaying||this.isPaused)return;const e=this.audioContext.currentTime;this.resumeTime=e-this.startTime-this.startDelay,this.isPausing=!0,await this.playPromise,this.isPausing=!1,this.isPaused=!0}async resume(){if(!this.isPaused)return;this.playPromise=this.playNotes(),await this.playPromise,this.isPaused=!1}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){const n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e+this.startDelay}currentTime(){if(!this.isPlaying)return this.resumeTime;const e=this.audioContext.currentTime;return e+this.resumeTime-this.startTime}processScheduledNotes(e,t){const n=e.scheduledNotes;for(let s=e.scheduleIndex;s<n.length;s++){const o=n[s];if(!o)continue;if(o.ending)continue;t(o)}}processActiveNotes(e,t,n){const s=e.scheduledNotes;for(let i=e.scheduleIndex;i<s.length;i++){const o=s[i];if(!o)continue;if(o.ending)continue;if(t<o.startTime)break;n(o)}}createConvolutionReverbImpulse(e,t,n){const s=e.sampleRate,o=s*t,i=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:s}),a=Math.min(s*n,o);for(let e=0;e<i.numberOfChannels;e++){const n=i.getChannelData(e);for(let e=0;e<a;e++)n[e]=Math.random()*2-1;const r=1/(s*t);for(let e=a;e<o;e++){const t=Math.exp(-(e-a)*r);n[e]=(Math.random()*2-1)*t}}return i}createConvolutionReverb(e,t){const n=new ConvolverNode(e,{buffer:t});return{input:n,output:n,convolverNode:n}}createCombFilter(e,t,n,s){const o=new DelayNode(e,{maxDelayTime:n,delayTime:n}),i=new GainNode(e,{gain:s});return t.connect(o),o.connect(i),i.connect(o),o}createAllpassFilter(e,t,n,s){const o=new DelayNode(e,{maxDelayTime:n,delayTime:n}),i=new GainNode(e,{gain:s}),a=new GainNode(e,{gain:1-s});return t.connect(o),o.connect(i),i.connect(o),o.connect(a),a}generateDistributedArray(e,t,n=.1,s=.05){const o=e*n,i=new Array(t);for(let n=0;n<t;n++){const a=n/(t-1||1),r=e-o+a*2*o;i[n]=r*(1-(Math.random()*2-1)*s)}return i}createSchroederReverb(e,t,n,s,o){const a=new GainNode(e),r=new GainNode(e);for(let s=0;s<n.length;s++){const o=this.createCombFilter(e,a,n[s],t[s]);o.connect(r)}const i=[];for(let t=0;t<o.length;t++){const n=this.createAllpassFilter(e,t===0?r:i.at(-1),o[t],s[t]);i.push(n)}const c=i.at(-1);return{input:a,output:c}}createReverbEffect(e){const{algorithm:s,time:t,feedback:n}=this.reverb;switch(s){case"ConvolutionReverb":{const s=this.createConvolutionReverbImpulse(e,t,this.calcDelay(t,n));return this.createConvolutionReverb(e,s)}case"SchroederReverb":{const s=this.generateDistributedArray(n,4),i=s.map(e=>this.calcDelay(t,e)),o=this.generateDistributedArray(n,4),a=o.map(e=>this.calcDelay(t,e));return this.createSchroederReverb(e,s,i,o,a)}}}createChorusEffect(e){const o=new GainNode(e),t=new GainNode(e),i=new GainNode(e),n=new OscillatorNode(e,{frequency:this.chorus.modRate}),s=new GainNode(e,{gain:this.chorus.modDepth/2}),a=this.chorus.delayTimes,r=[],c=[];for(let i=0;i<a.length;i++){const d=a[i],n=new DelayNode(e,{maxDelayTime:.1,delayTime:d}),l=new GainNode(e,{gain:this.chorus.feedback});r.push(n),c.push(l),o.connect(n),s.connect(n.delayTime),n.connect(l),l.connect(n),n.connect(t)}return t.connect(i),n.connect(s),n.start(),{input:o,output:t,sendGain:i,lfo:n,lfoGain:s,delayNodes:r,feedbackGains:c}}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){const o=e.isDrum?0:this.masterCoarseTuning+this.masterFineTuning,i=e.coarseTuning+e.fineTuning,t=o+i,a=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800,n=a*r,s=e.channelPressureTable[0];if(0<=s){const o=(s-64)/37.5,i=o*e.state.channelPressure;return t+n+i}return t+n}calcNoteDetune(e,t){return e.scaleOctaveTuningTable[t.noteNumber%12]}updateChannelDetune(e,t){this.processScheduledNotes(e,n=>{this.updateDetune(e,n,t)})}updateDetune(e,t,n){const o=this.calcNoteDetune(e,t),i=this.getPitchControl(e,t),s=e.detune+o+i;if(this.isPortamento(e,t)){const o=t.startTime,i=(t.noteNumber-t.portamentoNoteNumber)*100,a=o+this.getPortamentoTime(e,t);t.bufferSource.detune.cancelScheduledValues(n).setValueAtTime(s-i,n).linearRampToValueAtTime(s,a)}else t.bufferSource.detune.cancelScheduledValues(n).setValueAtTime(s,n)}getPortamentoTime(e,t){const n=Math.abs(t.noteNumber-t.portamentoNoteNumber),s=Math.ceil(e.state.portamentoTime*127);return n/this.getPitchIncrementSpeed(s)/10}getPitchIncrementSpeed(e){const u=[[0,1e3],[6,100],[16,20],[32,10],[48,5],[64,2.5],[80,1],[96,.4],[112,.15],[127,.01]],t=new Array(u.length);for(let n=0;n<u.length;n++){const[s,o]=u[n];if(e===s)return o;t[n]=[s,Math.log(o)]}let n=0;for(let s=1;s<t.length;s++)if(e<=t[s][0]){n=s-1;break}const[h,i]=t[n],[m,r]=t[n+1],c=m-h,o=(e-h)/c;let d,l;if(n===0)d=(r-i)/c;else{const[e,s]=t[n-1];d=(r-s)/(m-e)}if(n===t.length-2)l=(r-i)/c;else{const[e,s]=t[n+2];l=(s-i)/(e-h)}const s=o*o,a=s*o,f=2*a-3*s+1,p=a-2*s+o,g=-2*a+3*s,v=a-s,b=f*i+g*r+c*(p*d+v*l);return Math.exp(b)}setPortamentoVolumeEnvelope(e,t,n){const{voiceParams:s,startTime:o}=t,i=this.cbToRatio(-s.initialAttenuation)*(1+this.getAmplitudeControl(e,t)),a=i*(1-s.volSustain),r=o+s.volDelay,c=this.getRelativeKeyBasedValue(e,t,73)*2,l=r+s.volAttack*c,d=l+s.volHold;t.volumeEnvelopeNode.gain.cancelScheduledValues(n).setValueAtTime(a,d)}setVolumeEnvelope(e,t,n){const{voiceParams:s,startTime:i}=t,o=this.cbToRatio(-s.initialAttenuation)*(1+this.getAmplitudeControl(e,t)),l=o*(1-s.volSustain),a=i+s.volDelay,d=this.getRelativeKeyBasedValue(e,t,73)*2,r=a+s.volAttack*d,c=r+s.volHold,u=this.getRelativeKeyBasedValue(e,t,75)*2,h=c+s.volDecay*u;t.volumeEnvelopeNode.gain.cancelScheduledValues(n).setValueAtTime(0,i).setValueAtTime(1e-6,a).exponentialRampToValueAtTime(o,r).setValueAtTime(o,c).linearRampToValueAtTime(l,h)}setPortamentoPitchEnvelope(e,t){const n=e.voiceParams.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(n,t)}setPitchEnvelope(e,t){const{voiceParams:n}=e,s=n.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(s,t);const o=n.modEnvToPitch;if(o===0)return;const l=this.rateToCent(s),d=l+o,i=this.centToRate(d),a=e.startTime+n.modDelay,r=a+n.modAttack,c=r+n.modHold,u=c+n.modDecay;e.bufferSource.playbackRate.setValueAtTime(s,a).exponentialRampToValueAtTime(i,r).setValueAtTime(i,c).linearRampToValueAtTime(s,u)}clampCutoffFrequency(e){const t=20,n=2e4;return Math.max(t,Math.min(e,n))}setPortamentoFilterEnvelope(e,t,n){const{voiceParams:s,startTime:o}=t,c=this.getSoftPedalFactor(e,t),l=s.initialFilterFc+this.getFilterCutoffControl(e,t),a=this.getRelativeKeyBasedValue(e,t,74)*2,i=this.centToHz(l)*c*a,d=this.centToHz(s.initialFilterFc+s.modEnvToFilterFc)*a,u=i+(d-i)*(1-s.modSustain),r=this.clampCutoffFrequency(i),h=this.clampCutoffFrequency(u),m=o+this.getPortamentoTime(e,t),f=o+s.modDelay;t.filterNode.frequency.cancelScheduledValues(n).setValueAtTime(r,o).setValueAtTime(r,f).linearRampToValueAtTime(h,m)}setFilterEnvelope(e,t,n){const{voiceParams:s,startTime:l}=t,c=this.getSoftPedalFactor(e,t),a=s.initialFilterFc+this.getFilterCutoffControl(e,t),r=this.getRelativeKeyBasedValue(e,t,74)*2,o=this.centToHz(a)*c*r,i=this.centToHz(a+s.modEnvToFilterFc)*c*r,p=o+(i-o)*(1-s.modSustain),d=this.clampCutoffFrequency(o),u=this.clampCutoffFrequency(i),g=this.clampCutoffFrequency(p),h=l+s.modDelay,m=h+s.modAttack,f=m+s.modHold,v=f+s.modDecay;t.filterNode.frequency.cancelScheduledValues(n).setValueAtTime(d,l).setValueAtTime(d,h).exponentialRampToValueAtTime(u,m).setValueAtTime(u,f).linearRampToValueAtTime(g,v)}startModulation(e,t,n){const{voiceParams:s}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:s.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t,n),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(e,t,n),t.modulationLFO.start(t.startTime+s.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}startVibrato(e,t,n){const{voiceParams:s}=t,o=this.getRelativeKeyBasedValue(e,t,76)*2,i=this.getRelativeKeyBasedValue(e,t,78)*2;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqVibLFO)*o}),t.vibratoLFO.start(t.startTime+s.delayVibLFO*i),t.vibratoDepth=new GainNode(this.audioContext),this.setVibLfoToPitch(e,t,n),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async getAudioBuffer(e,t,n,s,o){const i=this.getVoiceId(e,t,n);if(o){const e=this.realtimeVoiceCache.get(i);if(e)return e;const t=await this.createAudioBuffer(s);return this.realtimeVoiceCache.set(i,t),t}const a=this.voiceCache.get(i);if(a)return a.counter+=1,a.maxCount<=a.counter&&this.voiceCache.delete(i),a.audioBuffer;const maxCount=this.voiceCounter.get(i)??0,audioBuffer=await this.createAudioBuffer(s),cache2={audioBuffer,maxCount,counter:1};return this.voiceCache.set(i,cache2),audioBuffer}async setNoteAudioNode(e,t,n){const s=this.audioContext.currentTime,{noteNumber:o,velocity:r,startTime:c}=t,l=e.state,d=this.getControllerState(e,o,r,0),i=t.voice.getAllParams(d);t.voiceParams=i;const u=await this.getAudioBuffer(e,o,r,i,n);t.bufferSource=this.createBufferSource(e,o,i,u),t.volumeEnvelopeNode=new GainNode(this.audioContext);const h=this.getRelativeKeyBasedValue(e,t,71);t.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:i.initialFilterQ/5*h});const a=e.scheduledNotes.at(-1);return a&&a.noteNumber!==o&&(t.portamentoNoteNumber=a.noteNumber),!e.isDrum&&this.isPortamento(e,t)?(this.setPortamentoVolumeEnvelope(e,t,s),this.setPortamentoFilterEnvelope(e,t,s),this.setPortamentoPitchEnvelope(t,s)):(this.setVolumeEnvelope(e,t,s),this.setFilterEnvelope(e,t,s),this.setPitchEnvelope(t,s)),this.updateDetune(e,t,s),0<l.vibratoDepth&&this.startVibrato(e,t,s),0<l.modulationDepth&&this.startModulation(e,t,s),e.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(c),e.currentBufferSource=t.bufferSource),t.bufferSource.connect(t.filterNode),t.filterNode.connect(t.volumeEnvelopeNode),this.setChorusSend(e,t,s),this.setReverbSend(e,t,s),t.bufferSource.start(c),t}handleExclusiveClass(e,t,n){const s=e.voiceParams.exclusiveClass;if(s===0)return;const o=this.exclusiveClassNotes[s];if(o){const[e,t]=o;e&&!e.ending&&this.noteOff(t,e.noteNumber,0,n,!0)}this.exclusiveClassNotes[s]=[e,t]}handleDrumExclusiveClass(e,t,n){const o=this.channels[t];if(!o.isDrum)return;const i=drumExclusiveClassesByKit[o.programNumber];if(!i)return;const a=i[e.noteNumber];if(a===0)return;const r=(a-1)*this.channels.length+t,s=this.drumExclusiveClassNotes[r];s&&!s.ending&&this.noteOff(t,s.noteNumber,0,n,!0),this.drumExclusiveClassNotes[r]=e}setNoteRouting(e,t,n){const s=this.channels[e],{noteNumber:o,volumeEnvelopeNode:i}=t;if(s.isDrum){const{keyBasedGainLs:t,keyBasedGainRs:n}=s;let e=t[o],a=n[o];if(!e){const s=this.createChannelAudioNodes(this.audioContext);e=t[o]=s.gainL,a=n[o]=s.gainR}i.connect(e),i.connect(a)}else i.connect(s.gainL),i.connect(s.gainR);.5<=s.state.sustainPedal&&s.sustainNotes.push(t),this.handleExclusiveClass(t,e,n),this.handleDrumExclusiveClass(t,e,n)}async noteOn(e,t,n,s){const i=this.channels[e],c=s===void 0;c&&(s=this.audioContext.currentTime);const o=new Note(t,n,s),l=i.scheduledNotes;o.index=l.length,l.push(o);const d=i.programNumber,a=this.soundFontTable[d];if(!a)return;const u=i.isDrum?128:i.bankLSB,h=a[u]!==void 0?u:0,m=a[h];if(m===void 0)return;const f=this.soundFonts[m];if(o.voice=f.getVoice(h,d,t,n),!o.voice)return;await this.setNoteAudioNode(i,o,c),this.setNoteRouting(e,o,s),o.pending=!1;const r=o.offEvent;r&&this.noteOff(e,t,r.velocity,r.startTime)}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop()),e.vibratoDepth&&(e.vibratoDepth.disconnect(),e.vibratoLFO.stop()),e.reverbSend&&e.reverbSend.disconnect(),e.chorusSend&&e.chorusSend.disconnect()}releaseNote(e,t,n){n??=this.audioContext.currentTime;const a=this.getRelativeKeyBasedValue(e,t,72)*2,s=n+t.voiceParams.volRelease*a,o=n+t.voiceParams.modRelease,i=Math.min(s,o);return t.filterNode.frequency.cancelScheduledValues(n).linearRampToValueAtTime(0,o),t.volumeEnvelopeNode.gain.cancelScheduledValues(n).linearRampToValueAtTime(0,s),new Promise(n=>{this.scheduleTask(()=>{const s=t.bufferSource;s.loop=!1,s.stop(i),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,n()},i)})}noteOff(e,t,n,s,o){const i=this.channels[e],c=i.state;if(!o)if(i.isDrum){if(!this.isLoopDrum(i,t))return}else{if(.5<=c.sustainPedal)return;if(.5<=c.sostenutoPedal)return}const r=this.findNoteOffIndex(i,t);if(r<0)return;const a=i.scheduledNotes[r];if(a.pending){a.offEvent={velocity:n,startTime:s};return}a.ending=!0,this.setNoteIndex(i,r),this.releaseNote(i,a,s)}setNoteIndex(e,t){let n=!0;for(let s=e.scheduleIndex;s<t;s++){const o=e.scheduledNotes[s];if(o&&!o.ending){n=!1;break}}n&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){const n=e.scheduledNotes;for(let s=e.scheduleIndex;s<n.length;s++){const o=n[s];if(!o)continue;if(o.ending)continue;if(o.noteNumber!==t)continue;return s}return-1}releaseSustainPedal(e,t,n){const i=t*2,s=this.channels[e],o=[];for(let t=0;t<s.sustainNotes.length;t++){const a=this.noteOff(e,s.sustainNotes[t].noteNumber,i,n);o.push(a)}return s.sustainNotes=[],o}releaseSostenutoPedal(e,t,n){const a=t*2,s=this.channels[e],o=[],i=s.sostenutoNotes;s.state.sostenutoPedal=0;for(let t=0;t<i.length;t++){const s=i[t],r=this.noteOff(e,s.noteNumber,a,n);o.push(r)}return s.sostenutoNotes=[],o}createMessageHandlers(){const e=new Array(256);return e[128]=(e,t)=>this.noteOff(e[0]&15,e[1],e[2],t),e[144]=(e,t)=>this.noteOn(e[0]&15,e[1],e[2],t),e[160]=(e,t)=>this.setPolyphonicKeyPressure(e[0]&15,e[1],e[2],t),e[176]=(e,t)=>this.setControlChange(e[0]&15,e[1],e[2],t),e[192]=(e,t)=>this.setProgramChange(e[0]&15,e[1],t),e[208]=(e,t)=>this.setChannelPressure(e[0]&15,e[1],t),e[224]=(e,t)=>this.handlePitchBendMessage(e[0]&15,e[1],e[2],t),e[254]=()=>this.activeSensing(),e}handleMessage(e,t){const n=e[0];if(n===240)return this.handleSysEx(e.subarray(1),t);const s=this.messageHandlers[n];s&&s(e,t)}activeSensing(){this.lastActiveSensing=performance.now()}setPolyphonicKeyPressure(e,t,n,s){const o=this.channels[e],i=o.polyphonicKeyPressureTable;this.processActiveNotes(o,s,e=>{e.noteNumber===t&&(e.pressure=n,this.setEffects(o,e,i,s))}),this.applyVoiceParams(o,10)}setProgramChange(e,t){const s=this.channels[e];if(s.programNumber=t,this.mode==="GM2")switch(s.bankMSB){case 120:s.isDrum=!0,s.keyBasedTable.fill(-1);break;case 121:s.isDrum=!1;break}}setChannelPressure(e,t,n){const s=this.channels[e];if(s.isDrum)return;const a=s.state.channelPressure,o=t/127;s.state.channelPressure=o;const i=s.channelPressureTable[0];if(0<=i){const e=(i-64)/37.5;s.detune+=e*(o-a)}const r=s.channelPressureTable;this.processActiveNotes(s,n,e=>{this.setEffects(s,e,r,n)}),this.applyVoiceParams(s,13)}handlePitchBendMessage(e,t,n,s){const o=n*128+t;this.setPitchBend(e,o,s)}setPitchBend(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime;const o=s.state,i=o.pitchWheel*2-1,a=(t-8192)/8192;o.pitchWheel=t/16383,s.detune+=(a-i)*o.pitchWheelSensitivity*12800,this.updateChannelDetune(s,n),this.applyVoiceParams(s,14,n)}setModLfoToPitch(e,t,n){if(t.modulationDepth){const s=t.voiceParams.modLfoToPitch+this.getLFOPitchDepth(e,t),o=Math.abs(s)+e.state.modulationDepth,i=o*Math.sign(s);t.modulationDepth.gain.cancelScheduledValues(n).setValueAtTime(i,n)}else this.startModulation(e,t,n)}setVibLfoToPitch(e,t,n){if(t.vibratoDepth){const o=this.getKeyBasedValue(e,t.noteNumber,77)*2,s=t.voiceParams.vibLfoToPitch,i=Math.abs(s)*o,a=i*Math.sign(s);t.vibratoDepth.gain.cancelScheduledValues(n).setValueAtTime(a,n)}else this.startVibrato(e,t,n)}setModLfoToFilterFc(e,t,n){const s=t.voiceParams.modLfoToFilterFc+this.getLFOFilterDepth(e,t);t.filterDepth.gain.cancelScheduledValues(n).setValueAtTime(s,n)}setModLfoToVolume(e,t,n){const s=t.voiceParams.modLfoToVolume,o=this.cbToRatio(Math.abs(s))-1,i=o*Math.sign(s)*(1+this.getLFOAmplitudeDepth(e,t));t.volumeDepth.gain.cancelScheduledValues(n).setValueAtTime(i,n)}setReverbSend(e,t,n){let s=t.voiceParams.reverbEffectsSend*e.state.reverbSendLevel;if(e.isDrum){const n=this.getKeyBasedValue(e,t.noteNumber,91);0<=n&&(s=n/127)}if(t.reverbSend)if(t.reverbSend.gain.cancelScheduledValues(n).setValueAtTime(s,n),0<s)t.volumeEnvelopeNode.connect(t.reverbSend);else try{t.volumeEnvelopeNode.disconnect(t.reverbSend)}catch{}else 0<s&&(t.reverbSend=new GainNode(this.audioContext,{gain:s}),t.volumeEnvelopeNode.connect(t.reverbSend),t.reverbSend.connect(this.reverbEffect.input))}setChorusSend(e,t,n){let s=t.voiceParams.chorusEffectsSend*e.state.chorusSendLevel;if(e.isDrum){const n=this.getKeyBasedValue(e,t.noteNumber,93);0<=n&&(s=n/127)}if(t.chorusSend)if(t.chorusSend.gain.cancelScheduledValues(n).setValueAtTime(s,n),0<s)t.volumeEnvelopeNode.connect(t.chorusSend);else try{t.volumeEnvelopeNode.disconnect(t.chorusSend)}catch{}else 0<s&&(t.chorusSend=new GainNode(this.audioContext,{gain:s}),t.volumeEnvelopeNode.connect(t.chorusSend),t.chorusSend.connect(this.chorusEffect.input))}setDelayModLFO(e){const t=e.startTime+e.voiceParams.delayModLFO;try{e.modulationLFO.start(t)}catch{}}setFreqModLFO(e,t){const n=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(n,t)}setFreqVibLFO(e,t,n){const s=this.getRelativeKeyBasedValue(e,t,76)*2,o=t.voiceParams.freqVibLFO;t.vibratoLFO.frequency.cancelScheduledValues(n).setValueAtTime(o*s,n)}setDelayVibLFO(e,t){const n=this.getRelativeKeyBasedValue(e,t,78)*2,s=t.voiceParams.delayVibLFO,o=t.startTime+s*n;try{t.vibratoLFO.start(o)}catch{}}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,n)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t,n)},vibLfoToPitch:(e,t,n)=>{0<e.state.vibratoDepth&&this.setVibLfoToPitch(e,t,n)},modLfoToFilterFc:(e,t,n)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(e,t,n)},modLfoToVolume:(e,t,n)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(e,t,n)},chorusEffectsSend:(e,t,n)=>{this.setChorusSend(e,t,n)},reverbEffectsSend:(e,t,n)=>{this.setReverbSend(e,t,n)},delayModLFO:(e,t)=>{0<channel.state.modulationDepth&&this.setDelayModLFO(t)},freqModLFO:(e,t,n)=>{0<channel.state.modulationDepth&&this.setFreqModLFO(t,n)},delayVibLFO:(e,t)=>{0<e.state.vibratoDepth&&setDelayVibLFO(e,t)},freqVibLFO:(e,t,n)=>{0<e.state.vibratoDepth&&this.setFreqVibLFO(e,t,n)}}}getControllerState(e,t,n,s){const o=new Float32Array(e.state.array.length);return o.set(e.state.array),o[2]=n/127,o[3]=t/127,o[10]=s/127,o[13]=o.channelPressure/127,o}applyVoiceParams(e,t,n){this.processScheduledNotes(e,s=>{const r=this.getControllerState(e,s.noteNumber,s.velocity,s.pressure),c=s.voice.getParams(t,r);let o=!1,i=!1,a=!1;for(const[t,r]of Object.entries(c)){const l=s.voiceParams[t];if(r===l)continue;s.voiceParams[t]=r,t in this.voiceParamsHandlers?this.voiceParamsHandlers[t](e,s,n):(volumeEnvelopeKeySet.has(t)&&(o=!0),filterEnvelopeKeySet.has(t)&&(i=!0),pitchEnvelopeKeySet.has(t)&&(a=!0))}o&&this.setVolumeEnvelope(e,s,n),i&&this.setFilterEnvelope(e,s,n),a&&this.setPitchEnvelope(s,n)})}createControlChangeHandlers(){const e=new Array(128);return e[0]=this.setBankMSB,e[1]=this.setModulationDepth,e[5]=this.setPortamentoTime,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[32]=this.setBankLSB,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[65]=this.setPortamento,e[66]=this.setSostenutoPedal,e[67]=this.setSoftPedal,e[71]=this.setFilterResonance,e[72]=this.setReleaseTime,e[73]=this.setAttackTime,e[74]=this.setBrightness,e[75]=this.setDecayTime,e[76]=this.setVibratoRate,e[77]=this.setVibratoDepth,e[78]=this.setVibratoDelay,e[91]=this.setReverbSendLevel,e[93]=this.setChorusSendLevel,e[96]=this.dataIncrement,e[97]=this.dataDecrement,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e[124]=this.omniOff,e[125]=this.omniOn,e[126]=this.monoOn,e[127]=this.polyOn,e}setControlChange(e,t,n,s){const o=this.controlChangeHandlers[t];if(o){o.call(this,e,n,s);const i=this.channels[e];this.applyVoiceParams(i,t+128,s),this.setControlChangeEffects(i,t,s)}else console.warn(`Unsupported Control change: controllerType=${t} value=${n}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e,t){const n=e.state.modulationDepth*e.modulationDepthRange;this.processScheduledNotes(e,s=>{s.modulationDepth?s.modulationDepth.gain.setValueAtTime(n,t):this.startModulation(e,s,t)})}setModulationDepth(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.modulationDepth=t/127,this.updateModulation(s,n)}updatePortamento(e,t){if(e.isDrum)return;this.processScheduledNotes(e,n=>{this.isPortamento(e,n)?(this.setPortamentoVolumeEnvelope(e,n,t),this.setPortamentoFilterEnvelope(e,n,t),this.setPortamentoPitchEnvelope(n,t),this.updateDetune(e,n,t)):(this.setVolumeEnvelope(e,n,t),this.setFilterEnvelope(e,n,t),this.setPitchEnvelope(n,t),this.updateDetune(e,n,t))})}setPortamentoTime(e,t,n){const s=this.channels[e];if(n??=this.audioContext.currentTime,s.state.portamentoTime=t/127,s.isDrum)return;this.updatePortamento(s,n)}setVolume(e,t,n){n??=this.audioContext.currentTime;const s=this.channels[e];if(s.state.volume=t/127,s.isDrum)for(let e=0;e<128;e++)this.updateKeyBasedVolume(s,e,n);else this.updateChannelVolume(s,n)}panToGain(e){const t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,n){n??=this.audioContext.currentTime;const s=this.channels[e];if(s.state.pan=t/127,s.isDrum)for(let e=0;e<128;e++)this.updateKeyBasedVolume(s,e,n);else this.updateChannelVolume(s,n)}setExpression(e,t,n){n??=this.audioContext.currentTime;const s=this.channels[e];s.state.expression=t/127,this.updateChannelVolume(s,n)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t,n){this.channels[e].dataLSB=t,this.handleRPN(e,0,n)}updateChannelVolume(e,t){const n=e.state,s=n.volume*n.expression,{gainLeft:o,gainRight:i}=this.panToGain(n.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(s*o,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(s*i,t)}updateKeyBasedVolume(e,t,n){const o=e.keyBasedGainLs[t];if(!o)return;const l=e.keyBasedGainRs[t],s=e.state,i=s.volume*s.expression,d=s.pan,a=this.getKeyBasedValue(e,t,7),r=0<=a?i*a/64:i,c=this.getKeyBasedValue(e,t,10),u=0<=c?c/127:d,{gainLeft:h,gainRight:m}=this.panToGain(u);o.gain.cancelScheduledValues(n).setValueAtTime(r*h,n),l.gain.cancelScheduledValues(n).setValueAtTime(r*m,n)}setSustainPedal(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(s,e=>{s.sustainNotes.push(e)}):this.releaseSustainPedal(e,t,n)}isPortamento(e,t){return.5<=e.state.portamento&&0<=t.portamentoNoteNumber}setPortamento(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.portamento=t/127,this.updatePortamento(s,n)}setSostenutoPedal(e,t,n){const s=this.channels[e];if(s.isDrum)return;if(n??=this.audioContext.currentTime,s.state.sostenutoPedal=t/127,64<=t){const e=[];this.processActiveNotes(s,n,t=>{e.push(t)}),s.sostenutoNotes=e}else this.releaseSostenutoPedal(e,t,n)}getSoftPedalFactor(e,t){return 1-(.1+t.noteNumber/127*.2)*e.state.softPedal}setSoftPedal(e,t,n){const s=this.channels[e];if(s.isDrum)return;const o=s.state;n??=this.audioContext.currentTime,o.softPedal=t/127,this.processScheduledNotes(s,e=>{this.isPortamento(s,e)?(this.setPortamentoVolumeEnvelope(s,e,n),this.setPortamentoFilterEnvelope(s,e,n)):(this.setVolumeEnvelope(s,e,n),this.setFilterEnvelope(s,e,n))})}setFilterResonance(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime;const o=s.state;o.filterResonance=t/127;const i=this.getRelativeKeyBasedValue(s,note,71);this.processScheduledNotes(s,e=>{const t=e.voiceParams.initialFilterQ/5*i;e.filterNode.Q.setValueAtTime(t,n)})}getRelativeKeyBasedValue(e,t,n){const s=e.state.array[128+n],o=this.getKeyBasedValue(e,t.noteNumber,n);if(o<0)return s;const i=s+o/127-.5;return i<0?i:0}setReleaseTime(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.releaseTime=t/127}setAttackTime(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.attackTime=t/127,this.processScheduledNotes(s,e=>{n<e.startTime&&this.setVolumeEnvelope(s,e,n)})}setBrightness(e,t,n){const s=this.channels[e];if(s.isDrum)return;const o=s.state;n??=this.audioContext.currentTime,o.brightness=t/127,this.processScheduledNotes(s,e=>{this.isPortamento(s,e)?this.setPortamentoFilterEnvelope(s,e,n):this.setFilterEnvelope(s,e,n)})}setDecayTime(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.decayTime=t/127,this.processScheduledNotes(s,e=>{this.setVolumeEnvelope(s,e,n)})}setVibratoRate(e,t,n){const s=this.channels[e];if(s.isDrum)return;if(n??=this.audioContext.currentTime,s.state.vibratoRate=t/127,s.vibratoDepth<=0)return;this.processScheduledNotes(s,e=>{this.setVibLfoToPitch(s,e,n)})}setVibratoDepth(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime;const o=s.state.vibratoDepth;s.state.vibratoDepth=t/127,0<o?this.processScheduledNotes(s,e=>{this.setFreqVibLFO(s,e,n)}):this.processScheduledNotes(s,e=>{this.startVibrato(s,e,n)})}setVibratoDelay(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.state.vibratoDelay=t/127,0<s.state.vibratoDepth&&this.processScheduledNotes(s,e=>{this.startVibrato(s,e,n)})}setReverbSendLevel(e,t,n){n??=this.audioContext.currentTime;const s=this.channels[e],o=s.state;o.reverbSendLevel=t/127,this.processScheduledNotes(s,e=>{this.setReverbSend(s,e,n)})}setChorusSendLevel(e,t,n){n??=this.audioContext.currentTime;const s=this.channels[e],o=s.state;o.chorusSendLevel=t/127,this.processScheduledNotes(s,e=>{this.setChorusSend(s,e,n)})}limitData(e,t,n,s,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=s):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=s)}limitDataMSB(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t,n){const s=this.channels[e],o=s.rpnMSB*128+s.rpnLSB;switch(o){case 0:s.dataLSB+=t,this.handlePitchBendRangeRPN(e,n);break;case 1:s.dataLSB+=t,this.handleFineTuningRPN(e,n);break;case 2:s.dataMSB+=t,this.handleCoarseTuningRPN(e,n);break;case 5:s.dataLSB+=t,this.handleModulationDepthRangeRPN(e,n);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${s.rpnMSB} LSB=${s.rpnLSB}`)}}dataIncrement(e,t){t??=this.audioContext.currentTime,this.handleRPN(e,1,t)}dataDecrement(e,t){t??=this.audioContext.currentTime,this.handleRPN(e,-1,t)}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,n){this.channels[e].dataMSB=t,this.handleRPN(e,0,n)}handlePitchBendRangeRPN(e,t){const n=this.channels[e];this.limitData(n,0,127,0,127);const s=(n.dataMSB+n.dataLSB/128)*100;this.setPitchBendRange(e,s,t)}setPitchBendRange(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime;const o=s.state,a=o.pitchWheelSensitivity,i=t/12800;o.pitchWheelSensitivity=i,s.detune+=(o.pitchWheel*2-1)*(i-a)*12800,this.updateChannelDetune(s,n),this.applyVoiceParams(s,16,n)}handleFineTuningRPN(e,t){const n=this.channels[e];this.limitData(n,0,127,0,127);const s=n.dataMSB*128+n.dataLSB,o=(s-8192)/8192*100;this.setFineTuning(e,o,t)}setFineTuning(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime;const i=s.fineTuning,o=t;s.fineTuning=o,s.detune+=o-i,this.updateChannelDetune(s,n)}handleCoarseTuningRPN(e,t){const n=this.channels[e];this.limitDataMSB(n,0,127);const s=(n.dataMSB-64)*100;this.setCoarseTuning(e,s,t)}setCoarseTuning(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime;const i=s.coarseTuning,o=t;s.coarseTuning=o,s.detune+=o-i,this.updateChannelDetune(s,n)}handleModulationDepthRangeRPN(e,t){const n=this.channels[e];this.limitData(n,0,127,0,127);const s=(n.dataMSB+n.dataLSB/128)*100;this.setModulationDepthRange(e,s,t)}setModulationDepthRange(e,t,n){const s=this.channels[e];if(s.isDrum)return;n??=this.audioContext.currentTime,s.modulationDepthRange=t,this.updateModulation(s,n)}allSoundOff(e,t,n){return n??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!0,n)}resetChannelStates(e){const n=this.audioContext.currentTime,t=this.channels[e],s=t.state,o=Object.entries(defaultControllerState);for(const[a,{type:t,defaultValue:i}]of o)128<=t?this.setControlChange(e,t-128,Math.ceil(i*127),n):s[a]=i;for(const e of Object.keys(this.constructor.channelSettings))t[e]=this.constructor.channelSettings[e];this.resetChannelTable(t),this.mode="GM2",this.masterFineTuning=0,this.masterCoarseTuning=0}resetAllControllers(e,t,n){const s=["polyphonicKeyPressure","channelPressure","pitchWheel","expression","modulationDepth","sustainPedal","portamento","sostenutoPedal","softPedal"],o=this.channels[e],a=o.state;for(let t=0;t<s.length;t++){const o=s[t],{type:i,defaultValue:r}=defaultControllerState[o];128<=i?this.setControlChange(e,i-128,Math.ceil(r*127),n):a[o]=r}this.setPitchBend(e,8192,n);const i=["rpnMSB","rpnLSB"];for(let e=0;e<i.length;e++){const t=i[e];o[t]=this.constructor.channelSettings[t]}}allNotesOff(e,t,n){return n??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!1,n)}omniOff(e,t,n){this.allNotesOff(e,t,n)}omniOn(e,t,n){this.allNotesOff(e,t,n)}monoOn(e,t,n){const s=this.channels[e];this.allNotesOff(e,t,n),s.mono=!0}polyOn(e,t,n){const s=this.channels[e];this.allNotesOff(e,t,n),s.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!1,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!1,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;case 3:this.GM2SystemOn(t);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM1";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);const n=this.channels[t];n.bankMSB=0,n.bankLSB=0,n.isDrum=!1}this.channels[9].bankMSB=1,this.channels[9].isDrum=!0}GM2SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM2";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);const n=this.channels[t];n.bankMSB=121,n.bankLSB=0,n.isDrum=!1}this.channels[9].bankMSB=120,this.channels[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);case 3:return this.handleMasterFineTuningSysEx(e,t);case 4:return this.handleMasterCoarseTuningSysEx(e,t);case 5:return this.handleGlobalParameterControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!0,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!0,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:return this.handlePressureSysEx(e,"channelPressureTable",t);case 2:return this.handlePressureSysEx(e,"polyphonicKeyPressureTable",t);case 3:return this.handleControlChangeSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:switch(e[3]){case 1:return this.handleKeyBasedInstrumentControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){const n=(e[5]*128+e[4])/16383;this.setMasterVolume(n,t)}setMasterVolume(e,t){t??=this.audioContext.currentTime,this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleMasterFineTuningSysEx(e,t){const n=(e[5]*128+e[4])/16383,s=(n-8192)/8192*100;this.setMasterFineTuning(s,t)}setMasterFineTuning(e,t){const s=this.masterFineTuning,n=e;this.masterFineTuning=n;const o=n-s;for(let e=0;e<this.channels.length;e++){const n=this.channels[e];if(n.isDrum)continue;n.detune+=o,this.updateChannelDetune(n,t)}}handleMasterCoarseTuningSysEx(e,t){const n=(e[4]-64)*100;this.setMasterCoarseTuning(n,t)}setMasterCoarseTuning(e,t){const s=this.masterCoarseTuning,n=e;this.masterCoarseTuning=n;const o=n-s;for(let e=0;e<this.channels.length;e++){const n=this.channels[e];if(n.isDrum)continue;n.detune+=o,this.updateChannelDetune(n,t)}}handleGlobalParameterControlSysEx(e,t){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e,t);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8,this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e),this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTime(e){return Math.exp((e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e,t){switch(e[9]){case 0:return this.setChorusType(e[10],t);case 1:return this.setChorusModRate(e[10],t);case 2:return this.setChorusModDepth(e[10],t);case 3:return this.setChorusFeedback(e[10],t);case 4:return this.setChorusSendToReverb(e[10],t)}}setChorusType(e,t){switch(e){case 0:return this.setChorusParameter(3,5,0,0,t);case 1:return this.setChorusParameter(9,19,5,0,t);case 2:return this.setChorusParameter(3,19,8,0,t);case 3:return this.setChorusParameter(9,16,16,0,t);case 4:return this.setChorusParameter(2,24,64,0,t);case 5:return this.setChorusParameter(1,5,112,0,t);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,n,s,o){this.setChorusModRate(e,o),this.setChorusModDepth(t,o),this.setChorusFeedback(n,o),this.setChorusSendToReverb(s,o)}setChorusModRate(e,t){const n=this.getChorusModRate(e);this.chorus.modRate=n,this.chorusEffect.lfo.frequency.setValueAtTime(n,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e,t){const n=this.getChorusModDepth(e);this.chorus.modDepth=n,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(n/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e,t){const n=this.getChorusFeedback(e);this.chorus.feedback=n;const s=this.chorusEffect;for(let e=0;e<s.feedbackGains.length;e++)s.feedbackGains[e].gain.cancelScheduledValues(t).setValueAtTime(n,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e,t){const n=this.getChorusSendToReverb(e),s=this.chorusEffect.sendGain;0<this.chorus.sendToReverb?(this.chorus.sendToReverb=n,0<n?s.gain.cancelScheduledValues(t).setValueAtTime(n,t):s.disconnect()):(this.chorus.sendToReverb=n,0<n&&(s.connect(this.reverbEffect.input),s.gain.cancelScheduledValues(t).setValueAtTime(n,t)))}getChorusSendToReverb(e){return e*.00787}getChannelBitmap(e){const t=new Array(this.channels.length).fill(!1),n=e[4]&3,s=e[5]&127,o=e[6]&127;for(let e=0;e<7;e++)o&1<<e&&(t[e]=!0);for(let e=0;e<7;e++)s&1<<e&&(t[e+7]=!0);for(let e=0;e<2;e++)n&1<<e&&(t[e+14]=!0);return t}handleScaleOctaveTuning1ByteFormatSysEx(e,t,n){if(e.length<19){console.error("Data length is too short");return}const s=this.getChannelBitmap(e);for(let o=0;o<s.length;o++){if(!s[o])continue;const i=this.channels[o];if(i.isDrum)continue;for(let t=0;t<12;t++){const n=e[t+7]-64;i.scaleOctaveTuningTable[t]=n}t&&this.updateChannelDetune(i,n)}}handleScaleOctaveTuning2ByteFormatSysEx(e,t,n){if(e.length<31){console.error("Data length is too short");return}const s=this.getChannelBitmap(e);for(let o=0;o<s.length;o++){if(!s[o])continue;const i=this.channels[o];if(i.isDrum)continue;for(let t=0;t<12;t++){const n=7+t*2,s=e[n]&127,o=e[n+1]&127,a=s*128+o,r=(a-8192)/8.192;i.scaleOctaveTuningTable[t]=r}t&&this.updateChannelDetune(i,n)}}getPitchControl(e,t){const n=e.polyphonicKeyPressureTable[0];if(n<0)return 0;const s=(n-64)*t.pressure;return s*t.pressure/37.5}getFilterCutoffControl(e,t){const n=e.channelPressureTable[1],o=0<=n?(n-64)*e.state.channelPressure:0,s=e.polyphonicKeyPressureTable[1],i=0<=s?(s-64)*t.pressure:0;return(o+i)*15}getAmplitudeControl(e,t){const n=e.channelPressureTable[2],o=0<=n?n*e.state.channelPressure:0,s=e.polyphonicKeyPressureTable[2],i=0<=s?s*t.pressure:0;return(o+i)/128}getLFOPitchDepth(e,t){const n=e.channelPressureTable[3],o=0<=n?n*e.state.channelPressure:0,s=e.polyphonicKeyPressureTable[3],i=0<=s?s*t.pressure:0;return(o+i)/254*600}getLFOFilterDepth(e,t){const n=e.channelPressureTable[4],o=0<=n?n*e.state.channelPressure:0,s=e.polyphonicKeyPressureTable[4],i=0<=s?s*t.pressure:0;return(o+i)/254*2400}getLFOAmplitudeDepth(e,t){const n=e.channelPressureTable[5],o=0<=n?n*e.state.channelPressure:0,s=e.polyphonicKeyPressureTable[5],i=0<=s?s*t.pressure:0;return(o+i)/254}setEffects(e,t,n,s){0<=n[0]&&this.updateDetune(e,t,s),.5<=e.state.portamemento&&0<=t.portamentoNoteNumber?(0<=n[1]&&this.setPortamentoFilterEnvelope(e,t,s),0<=n[2]&&this.setPortamentoVolumeEnvelope(e,t,s)):(0<=n[1]&&this.setFilterEnvelope(e,t,s),0<=n[2]&&this.setVolumeEnvelope(e,t,s)),0<=n[3]&&this.setModLfoToPitch(e,t,s),0<=n[4]&&this.setModLfoToFilterFc(e,t,s),0<=n[5]&&this.setModLfoToVolume(e,t,s)}handlePressureSysEx(e,t,n){const i=e[4],s=this.channels[i];if(s.isDrum)return;const o=s[t];for(let t=5;t<e.length-1;t+=2){const n=e[t],s=e[t+1];o[n]=s}this.processActiveNotes(s,n,e=>{this.setEffects(s,e,o,n)})}initControlTable(){const e=128,t=6;return new Int8Array(e*t).fill(-1)}setControlChangeEffects(e,t,n){const s=6,o=t*s,i=e.controlTable.subarray(o,o+s);this.processScheduledNotes(e,t=>{this.setEffects(e,t,i,n)})}handleControlChangeSysEx(e,t){const o=e[4],n=this.channels[o];if(n.isDrum)return;const i=6,s=e[5],a=s*i,r=n.controlTable;for(let t=6;t<e.length;t+=2){const n=e[t],s=e[t+1];r[a+n]=s}this.setControlChangeEffects(n,s,t)}getKeyBasedValue(e,t,n){const s=t*128+n,o=e.keyBasedTable[s];return o}createKeyBasedControllerHandlers(){const e=new Array(128);return e[7]=(e,t,n)=>this.updateKeyBasedVolume(e,t,n),e[10]=(e,t,n)=>this.updateKeyBasedVolume(e,t,n),e[71]=(e,t,n)=>this.processScheduledNotes(e,s=>{if(s.noteNumber===t){const t=this.getRelativeKeyBasedValue(e,s,71),o=s.voiceParams.initialFilterQ/5*t;s.filterNode.Q.setValueAtTime(o,n)}}),e[73]=(e,t,n)=>this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setVolumeEnvelope(e,s,n)}),e[74]=(e,t,n)=>this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setFilterEnvelope(e,s,n)}),e[75]=(e,t,n)=>this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setVolumeEnvelope(e,s,n)}),e[76]=(e,t,n)=>{if(e.state.vibratoDepth<=0)return;this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setFreqVibLFO(e,s,n)})},e[77]=(e,t,n)=>{if(e.state.vibratoDepth<=0)return;this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setVibLfoToPitch(e,s,n)})},e[78]=(e,t)=>{if(e.state.vibratoDepth<=0)return;this.processScheduledNotes(e,n=>{n.noteNumber===t&&this.setDelayVibLFO(e,n)})},e[91]=(e,t,n)=>this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setReverbSend(e,s,n)}),e[93]=(e,t,n)=>this.processScheduledNotes(e,s=>{s.noteNumber===t&&this.setChorusSend(e,s,n)}),e}handleKeyBasedInstrumentControlSysEx(e,t){const o=e[4],n=this.channels[o];if(!n.isDrum)return;const s=e[5],i=n.keyBasedTable;for(let o=6;o<e.length;o+=2){const a=e[o],c=e[o+1],l=s*128+a;i[l]=c;const r=this.keyBasedControllerHandlers[a];r&&r(n,s,t)}}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(n=>{const s=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});s.connect(this.scheduler),s.onended=()=>{try{e()}finally{s.disconnect(),n()}},s.start(t)})}},MIDIPlayer=class{soundFontURL="https://soundfonts.pages.dev/GeneralUser_GS_v1.471";midy;timer;currentTime=0;currTimeInterval=100;currTimeNode;totalTimeNode;seekBarNode;playNode;pauseNode;resumeNode;stopNode;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;constructor(e){this.midy=e,this.root=document.createElement("midi-player")}defaultLayout(){const e=this.row();e.appendChild(this.playPauseResume()),e.appendChild(this.volume()),e.appendChild(this.currTimeTotalTime()),e.appendChild(this.seekBar())}row(){const e=document.createElement("div");return e.className="midi-player-row",e.style.display="flex",e.style.alignItems="center",this.root.appendChild(e),e}formatTime(e){e=Math.floor(e);const n=e%60,t=(e-n)/60,s=(e-n-60*t)/3600,o=String(n).padStart(2,"0"),i=t>9||!s?`${t}:`:`0${t}:`,a=s?`${s}:`:"";return`${a}${i}${o}`}button(e,t,n,s){const o=document.createElement("div");return o.style.display=s,o.innerHTML=`
<button title="${e}" class="midi-player-btn ${t}" type="button">
  ${n}
</button>
`,o}formRange(e,t,n,s){const o=document.createElement("div");return o.innerHTML=`
<input title="${e}" class="midi-player-range ${t}" style="display:${s};"
  type="range" min="0" max="1" step="0.001" value="${n}">
`,o.firstElementChild}text(e,t){const n=document.createElement("div");return n.className=`midi-player-text ${t}`,n.textContent=e,n}startTimer(){const t=this.midy.totalTime;this.stopTimer();const e=()=>{const n=this.midy.currentTime();if(this.currTimeNode){const e=Math.ceil(n);this.currTimeNode.textContent=this.formatTime(e)}this.seekBarNode&&(this.seekBarNode.value=n/t),this.timer=requestAnimationFrame(e)};this.timer=requestAnimationFrame(e)}stopTimer(){this.timer&&(cancelAnimationFrame(this.timer),this.timer=null)}async loadMIDI(e){await this.midy.loadMIDI(e),this.totalTimeNode&&(this.totalTimeNode.textContent=this.formatTime(this.midy.totalTime))}setSoundFontDir(e){this.soundFontURL=e}getSoundFontPaths(){const e=[],{midy:t,soundFontURL:n}=this;for(const i of t.instruments){const[a,s]=i.split(":"),o=Number(a),r=Number(s),c=t.soundFontTable[r][o];if(c!==void 0)continue;const l=o===128?"128":s;e.push(`${n}/${l}.sf3`)}return e}async start(){this.isPlaying=!0;const e=this.midy;await e.loadSoundFont(this.getSoundFontPaths()),this.startTimer(),await e.start(),this.stopTimer(),this.isPlaying=!1,!e.isPaused&&this.currTimeNode&&(this.currTimeNode.textContent="0:00",this.seekBarNode.value=0)}async handleStop(){const e=this.midy;if(!e.isPlaying)return;this.isStopping=!0,this.playNode.style.display="initial",this.pauseNode.style.display="none",this.resumeNode.style.display="none",this.stopTimer(),await e.stop(),this.isPlaying=!1}stop(){const e=this.button("start","midi-player-start","stop","initial");return e.onclick=()=>this.handleStop(),this.stopNode=e,e}async handlePlay(){const{midy:e,playNode:t,pauseNode:n}=this;if(e.isPlaying||e.isPaused)return;this.isPlaying=!0,t.style.display="none",n.style.display="initial",await this.start(),this.isPlaying=!1,e.isPaused||(n.style.display="none",t.style.display="initial")}async handlePause(){const e=this.midy;if(!e.isPlaying||e.isPaused)return;this.isPausing=!0,this.pauseNode.style.display="none",this.resumeNode.style.display="initial",this.stopTimer(),await e.pause(),this.isPausing=!1,this.isPaused=!0}async handleResume(){const{midy:e,playNode:n,pauseNode:t,resumeNode:s}=this;if(!e.isPaused)return;this.isPlaying=!0,t.style.display="initial",s.style.display="none",this.startTimer(),await e.resume(),this.stopTimer(),this.isPlaying=!1,e.isPaused||(t.style.display="none",n.style.display="initial")}playPauseResume(){const t=this.button("start","midi-player-start","play_arrow","initial"),n=this.button("pause","midi-player-pause","pause","none"),s=this.button("resume","midi-player-resume","play_arrow","none");this.playNode=t,this.pauseNode=n,this.resumeNode=s,t.onclick=()=>this.handlePlay(),n.onclick=()=>this.handlePause(),s.onclick=()=>this.handleResume();const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e}volumeText(){return this.text("volume","midi-player-volumeText")}volume(){const t=this.button("mute ON","midi-player-muteOn","volume_down","initial"),n=this.button("mute OFF","midi-player-muteOff","volume_off","none"),s=this.formRange("volume","midi-player-volume",1,"none");t.onclick=()=>{t.style.display="none",n.style.display="initial",this.midy.setMasterVolume(0)},n.onclick=()=>{t.style.display="initial",n.style.display="none",this.midy.setMasterVolume(1)},s.oninput=e=>{this.midy.setMasterVolume(e.target.value)};const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e.onmouseover=()=>{s.style.display="initial"},e.onmouseout=()=>{s.style.display="none"},e}seekBar(){const e=this.formRange("playback position","midi-player-seekBar",0,"initial");return e.oninput=e=>{this.isSeeking=!0;const t=e.target.value*this.midy.totalTime;this.midy.seekTo(t),this.currTimeNode&&(this.currTimeNode.textContent=this.formatTime(t)),this.isSeeking=!1},this.seekBarNode=e,e}currTime(){const e=this.text("0:00","midi-player-currTime");return this.currTimeNode=e,e}totalTime(){const e=this.text("0:00","midi-player-totalTime");return this.totalTimeNode=e,e}currTimeTotalTime(){const t=this.currTime(),n=this.text("/","midi-player-timeSeparator"),s=this.totalTime(),e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e}},loadConfig();function applyTheme(e){const t=e.root;for(const e of t.getElementsByClassName("midi-player-btn"))e.classList.add("btn","btn-light","p-1");for(const e of t.getElementsByClassName("midi-player-text"))e.classList.add("p-1");for(const e of t.getElementsByClassName("midi-player-range"))e.classList.add("form-range","p-1")}function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}async function setProgramChange(e,t,n){const s=midy.channels[e],o=s.isDrum?128:s.bankLSB,i=midy.soundFontTable[t][o];if(i===void 0){const e=t.toString().padStart(3,"0"),n=o===128?"128":e,s=`${midiPlayer.soundFontURL}/${n}.sf3`;await midy.loadSoundFont(s)}midy.setProgramChange(e,t,n)}function clearAllKeys(e){for(let t=0;t<16;t++){const n=e[t];for(let e=0;e<n.length;e++){const t=n[e].style;t.fill&&t.removeProperty("fill")}}}async function noteOn(e,t,n){const s=Number(t.target.dataset.index);if(n[s])return;n[s]=!0;const o=Math.ceil(t.pressure*127)||64;await midy.noteOn(e,s,o)}function noteOff(e,t,n){const s=Number(t.target.dataset.index);n[s]=!1;const o=Math.ceil(t.pressure*127)||64;midy.noteOff(e,s,o)}function setPianoEvents(e,t){const n=new Array(128),s=e.shadowRoot.querySelectorAll("rect");for(let o=0;o<s.length;o++){const e=s[o];e.addEventListener("pointerenter",async e=>{if(!e.buttons)return;await noteOn(t,e,n)}),e.addEventListener("pointerleave",e=>{noteOff(t,e,n)}),e.addEventListener("pointerdown",async e=>{await noteOn(t,e,n)}),e.addEventListener("pointerup",e=>{noteOff(t,e,n)}),e.addEventListener("pointercancel",e=>{noteOff(t,e,n)})}e.addEventListener("pointerenter",async()=>{midy.audioContext.state==="suspended"&&await midy.audioContext.resume()}),e.addEventListener("pointerleave",async()=>{if(midiPlayer.isPlaying)return;midy.stopNotes(0,!0,midy.audioContext.currentTime),n.fill(!1),await midy.audioContext.suspend()})}function visualizerLoop(){if(!midiPlayer.isPlaying){clearAllKeys(pianos);return}const{startDelay:t,timeline:e}=midy,n=midy.currentTime();for(;scheduleIndex<e.length;scheduleIndex++){const s=e[scheduleIndex];if(n<s.startTime+t)break;switch(s.type){case"noteOn":{const e=30+s.velocity/127*40,t=`hsl(200, 80%, ${e}%)`,n=pianos[s.channel][s.noteNumber];n.style.setProperty("fill",t);break}case"noteOff":pianos[s.channel][s.noteNumber].style.removeProperty("fill");break;case"controller":switch(s.controllerType){case 7:volumes[s.channel].value=s.value;break;case 10:pans[s.channel].value=s.value;break;case 11:expressions[s.channel].value=s.value;break}break;case"programChange":{const e=programs[s.channel];e.value=s.programNumber,e.dispatchEvent(new Event("change",{bubbles:!0}))}}}requestAnimationFrame(visualizerLoop)}function setEvents(){const t="#midi-visualizer :is(input, midi-instrument, midi-piano)",e=document.querySelectorAll(t);for(let t=0;t<e.length;t+=6){const n=Math.floor(t/6),s=e[t];volumes.push(s),s.addEventListener("change",e=>{const t=midy.audioContext.currentTime;midy.setVolume(n,Number(e.target.value),t)});const o=e[t+1];expressions.push(o),o.addEventListener("change",e=>{const t=midy.audioContext.currentTime;midy.setExpression(n,Number(e.target.value),t)});const i=e[t+2];pans.push(i),i.addEventListener("change",e=>{const t=midy.audioContext.currentTime;midy.setPan(n,Number(e.target.value),t)});const a=e[t+3];programs.push(a),a.addEventListener("change",async s=>{const o=s.target;o.classList.toggle("is-invalid",!o.checkValidity());const a=midy.audioContext.currentTime,i=Number(o.value),r=e[t+4].shadowRoot.querySelector("select");r.selectedIndex=i,await setProgramChange(n,i,a)});const c=e[t+4].shadowRoot.querySelector("select");c.addEventListener("change",async s=>{const i=midy.audioContext.currentTime,o=Number(s.target.selectedIndex);e[t+3].value=o,await setProgramChange(n,o,i)});const r=e[t+5];pianos.push(r.shadowRoot.querySelectorAll("rect")),setPianoEvents(r,n)}}function getGlobalCSS(){let e="";for(const t of document.styleSheets)for(const n of t.cssRules)e+=n.cssText;const t=new CSSStyleSheet;return t.replaceSync(e),t}function initMIDIInstrumentElement(){class e extends HTMLElement{constructor(){super();const t=document.getElementById("midi-instrument"),e=this.attachShadow({mode:"open"});e.adoptedStyleSheets=[globalCSS],e.appendChild(t.content.cloneNode(!0))}}customElements.define("midi-instrument",e)}MidiPiano=class extends HTMLElement{constructor(){super();const t=document.getElementById("midi-piano"),e=this.attachShadow({mode:"open"});e.appendChild(t.content.cloneNode(!0));const n=e.querySelector(".wrapper"),s=this.createPianoSVG();n.appendChild(s)}createPianoSVG(){const t="http://www.w3.org/2000/svg",e=document.createElementNS(t,"svg"),n=128,s=1,i=.5,l=1,d=.6,a=[0,2,4,5,7,9,11],u=[1,3,6,8,10];let r=0;for(let e=0;e<n;e++)a.includes(e%12)&&r++;e.setAttribute("viewBox",`0 0 ${r} 1`),e.setAttribute("preserveAspectRatio","none");let o=0;const c=[];for(let i=0;i<n;i++){const r=i%12;if(a.includes(r)){const n=document.createElementNS(t,"rect");n.setAttribute("x",o),n.setAttribute("y",0),n.setAttribute("width",s),n.setAttribute("height",l),n.setAttribute("class","white"),n.setAttribute("data-index",i),e.appendChild(n),c[i]=o,o+=s}}for(let o=0;o<n;o++){const a=o%12;if(u.includes(a)){const n=document.createElementNS(t,"rect"),a=c[o-1]+s-i/2||0;n.setAttribute("x",a),n.setAttribute("y",0),n.setAttribute("width",i),n.setAttribute("height",d),n.setAttribute("class","black"),n.setAttribute("data-index",o),e.appendChild(n)}}return e}},customElements.define("midi-piano",MidiPiano);async function loadMIDI(e){if(!e)return;await midiPlayer.handleStop();const t=await e.arrayBuffer(),n=new Uint8Array(t);await midiPlayer.loadMIDI(n)}async function loadSoundFont(e){if(!e)return;const t=await e.arrayBuffer(),n=new Uint8Array(t);await midy.loadSoundFont(n)}async function loadFile(e){const t=e.name.split(".").at(-1).toLowerCase();switch(t){case"mid":case"midi":return await loadMIDI(e);case"sf2":case"sf3":return await loadSoundFont(e)}}globalCSS=getGlobalCSS(),initMIDIInstrumentElement(),midy=new Midy(new AudioContext),await midy.audioContext.suspend(),midiPlayer=new MIDIPlayer(midy),await midy.loadSoundFont(`${midiPlayer.soundFontURL}/000.sf3`),midiPlayer.defaultLayout(),applyTheme(midiPlayer),document.getElementById("midi-player").appendChild(midiPlayer.root),pianos=[],volumes=[],pans=[],expressions=[],programs=[],scheduleIndex=0,midiPlayer.playNode.addEventListener("click",()=>{midiPlayer.isPlaying=!0,scheduleIndex=0,requestAnimationFrame(visualizerLoop)}),midiPlayer.resumeNode.addEventListener("click",()=>{requestAnimationFrame(visualizerLoop)}),midiPlayer.pauseNode.addEventListener("click",()=>{}),midiPlayer.seekBarNode.addEventListener("change",()=>{clearAllKeys(pianos);const e=event.target.value*midy.totalTime;scheduleIndex=midy.getQueueIndex(e)}),setEvents(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("selectFile").onclick=()=>{document.getElementById("inputFile").click()},document.getElementById("inputFile").addEventListener("change",e=>{loadFile(e.target.files[0])}),globalThis.ondragover=e=>{e.preventDefault()},globalThis.ondrop=e=>{e.preventDefault();const t=e.dataTransfer.files[0];loadFile(t)},globalThis.addEventListener("paste",e=>{const n=e.clipboardData.items[0],t=n.getAsFile();if(!t)return;loadFile(t)})